<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DocuMed</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/style.css">
  <link rel="manifest" href="../../manifest-landing.json">
  <link rel="apple-touch-icon" href="../assets/images/documed_logo.png">
  <link rel="icon" type="image/png" href="../assets/images/documed_logo.png">
</head>
<body>
  <div class="main-wrapper">
    <nav class="top-nav">
      <div class="d-flex align-items-center">
        <div class="nav-logo"><img src="../assets/images/documed_logo.png" alt="DocuMed Logo"></div>
        <button class="nav-burger" aria-label="Toggle navigation"><span></span></button>
        <div class="nav-links">
          <a href="user_dashboard.html">Home</a>
          <!-- <a href="appointments.html">Appointment</a>
          <a href="medical_history.html">Medical History</a>
          <a href="profile.html">Profile</a> -->
          <a href="user_dashboard.html#services">Services</a>
          <a href="user_dashboard.html#about">About Us</a>
          <a href="user_dashboard.html#contact">Contact</a>
        </div>
      </div>
      <div class="nav-actions" id="navActions"></div>
    </nav>

    <div class="container" style="max-width:520px;margin:40px auto;padding:24px;background:#fff;border-radius:12px;box-shadow:0 4px 16px rgba(37,99,235,0.10)">
      <h1 class="h4 text-primary mb-3">Forgot your password?</h1>
      <p id="fpHelp" class="text-muted">Please enter your registered email. We will send a oneâ€‘time passcode (OTP) to that address so you can securely reset your password.</p>
      <div id="fpMsg" class="mb-2" style="display:none;"></div>
      <form id="forgotForm">
        <div class="mb-3">
          <label for="fpIdentifier" class="form-label">Registered Email</label>
          <input type="email" class="form-control" id="fpIdentifier" placeholder="name@example.com" required>
        </div>
        <button class="btn btn-outline-primary w-100" id="sendOtpBtn" type="button">Send OTP</button>
        <div id="otpSentMsg" class="mt-2" style="font-size:.9rem;"></div>
      </form>

      <!-- Divider between send OTP and OTP entry -->
      <hr id="otpDivider" class="my-4" />
      <form id="otpForm">
        <div id="otpEntryGroup" class="mb-3">
          <label for="fpOtp" class="form-label">Enter OTP</label>
          <div class="d-flex align-items-center" style="gap:10px;">
            <input type="text" class="form-control" id="fpOtp" maxlength="6" inputmode="numeric" pattern="^[0-9]{6}$" placeholder="6-digit code" required style="flex:1;">
            <button class="btn btn-outline-secondary" id="verifyOtpBtn" type="button">Verify OTP</button>
          </div>
        </div>
          <button type="button" id="backToOtpBtn" class="btn btn-outline-secondary w-100 mt-3" style="display:none;">Back</button>
        <div id="newPassWrap" style="display:none;">
          <div class="mb-3">
            <label for="fpPass" class="form-label">New Password</label>
            <input type="password" class="form-control" id="fpPass" minlength="6">
          </div>
          <div class="mb-3">
            <label for="fpPass2" class="form-label">Confirm Password</label>
            <input type="password" class="form-control" id="fpPass2" minlength="6">
          </div>
        </div>
        <button class="btn btn-primary w-100" id="resetBtn" type="submit" disabled>Reset Password</button>
      </form>
    </div>
  </div>
  <footer style="background:#0a6ecb;color:#fff;padding:32px 0 18px 0;margin-top:48px;width:100vw;">
    <div style="max-width:1100px;margin:auto;display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center;">
      <div id="footerClinicName" style="font-size:1.15rem;font-weight:600;letter-spacing:1px;">DocuMed Campus Clinic &copy; 2025</div>
      <div style="font-size:1rem;">For inquiries: <a href="mailto:clinic@documed.com" style="color:#fff;text-decoration:underline;">clinic@documed.com</a></div>
      <div style="font-size:1rem;">Powered by <span style="color:#00d1c7;font-weight:600;">DocuMed</span></div>
    </div>
  </footer>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../assets/js/mobile-nav.js"></script>
  <script src="../assets/js/required_star.js"></script>
  <script>
    const idInput = document.getElementById('fpIdentifier');
    const sendOtpBtn = document.getElementById('sendOtpBtn');
  const msg = document.getElementById('fpMsg');
  const otpSentMsg = document.getElementById('otpSentMsg');
  const helpPara = document.getElementById('fpHelp');
  const originalHelp = helpPara ? helpPara.innerHTML : '';
  const otpDivider = document.getElementById('otpDivider');

    sendOtpBtn.addEventListener('click', async function(){
      otpSentMsg.textContent='';
      const identifier = idInput.value.trim();
      if (!identifier) { otpSentMsg.className='text-danger'; otpSentMsg.textContent='Enter your registered email'; return; }
      // Request OTP (backend fetches email from DB and sends OTP there)
      try {
        const res = await fetch('../../backend/api/auth.php?action=request_password_otp', { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: 'identifier='+encodeURIComponent(identifier) });
        const data = await res.json();
        otpSentMsg.className = data.success ? 'text-success' : 'text-danger';
        otpSentMsg.textContent = data.message || (data.success ? 'OTP has been sent. Check your email.' : 'Request failed');
        // Do not display dev info in UI; rely on real email delivery
      } catch { otpSentMsg.className='text-danger'; otpSentMsg.textContent='Network error'; }
    });

    const newPassWrap = document.getElementById('newPassWrap');
    const verifyOtpBtn = document.getElementById('verifyOtpBtn');
    const resetBtn = document.getElementById('resetBtn');
      const backBtn = document.getElementById('backToOtpBtn');

    verifyOtpBtn.addEventListener('click', async function(){
      msg.textContent='';
      const identifier = idInput.value.trim();
      const otp = document.getElementById('fpOtp').value.trim();
      if (!identifier) { msg.className='text-danger'; msg.textContent='Enter your registered email'; return; }
      if (!/^\d{6}$/.test(otp)) { msg.className='text-danger'; msg.textContent='Enter the 6-digit OTP.'; return; }
      try {
        const body = new URLSearchParams({ identifier, otp }).toString();
        const res = await fetch('../../backend/api/auth.php?action=verify_password_otp', { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body });
        const data = await res.json();
        if (!data.success) {
          msg.style.display='block';
          msg.className='text-danger';
          msg.textContent = data.message || 'OTP invalid';
          return;
        }
        // Success path: hide any previous message, remove OTP visuals
        msg.textContent='';
        msg.style.display='none';
        if (data.success) {
          newPassWrap.style.display = 'block';
          resetBtn.disabled = false;
          // Lock the identifier and OTP to prevent tampering
          idInput.readOnly = true;
          document.getElementById('fpOtp').readOnly = true;
          // Hide other sections leaving only new password fields visible
          document.getElementById('forgotForm').style.display='none';
          document.getElementById('otpEntryGroup').style.display='none';
          if (otpDivider) otpDivider.style.display='none';
            backBtn.style.display='block'; // Show the Back button
          if (helpPara) helpPara.innerHTML = 'Please enter your strong password.';
          if (otpSentMsg) { otpSentMsg.textContent=''; otpSentMsg.style.display='none'; }
        }
      } catch { msg.className='text-danger'; msg.textContent='Network error'; }
    });

    // Back button logic to return to email + OTP entry
    backBtn?.addEventListener('click', function(){
      // Restore visibility
      document.getElementById('forgotForm').style.display='';
      document.getElementById('otpEntryGroup').style.display='';
      newPassWrap.style.display='none';
        backBtn.style.display='none'; // Hide the Back button
      if (otpDivider) otpDivider.style.display='block';
      // Restore help text
      if (helpPara) helpPara.innerHTML = originalHelp;
      // Show OTP sent container (empty)
      if (otpSentMsg) { otpSentMsg.style.display='block'; otpSentMsg.textContent=''; otpSentMsg.className='mt-2'; }
      // Unlock inputs for new attempt
      idInput.readOnly=false;
      const otpInput = document.getElementById('fpOtp');
      if (otpInput) otpInput.readOnly=false;
      // Clear password fields
      document.getElementById('fpPass').value='';
      document.getElementById('fpPass2').value='';
      // Reset messages
      msg.textContent=''; msg.className='';
      // Disable reset until re-verified
      resetBtn.disabled=true;
    });

    document.getElementById('otpForm').addEventListener('submit', async function(e){
      e.preventDefault();
      msg.textContent='';
      const identifier = idInput.value.trim();
      const otp = document.getElementById('fpOtp').value.trim();
      const pass = document.getElementById('fpPass').value;
      const pass2 = document.getElementById('fpPass2').value;
      if (!identifier) { msg.className='text-danger'; msg.textContent='Enter your registered email'; return; }
      if (newPassWrap.style.display !== 'block') { msg.className='text-danger'; msg.textContent='Verify your OTP first.'; return; }
      if (pass !== pass2) { msg.className='text-danger'; msg.textContent='Passwords do not match'; return; }
      try {
        const body = new URLSearchParams({ identifier, otp, new_password: pass }).toString();
        const res = await fetch('../../backend/api/auth.php?action=reset_password_otp', { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body });
        const data = await res.json();
        msg.className = data.success ? 'text-success' : 'text-danger';
        msg.textContent = data.message || (data.success ? 'Password updated' : 'Reset failed');
        if (data.success) { setTimeout(()=>{ window.location.href = 'user_login.html'; }, 1200); }
      } catch { msg.className='text-danger'; msg.textContent='Network error'; }
    });
  </script>
</body>
</html>
