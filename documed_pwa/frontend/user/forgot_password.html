<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DocuMed</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/style.css">
  <link rel="manifest" href="../../manifest-landing.json">
  <link rel="apple-touch-icon" href="../assets/images/documed_logo.png">
  <link rel="icon" type="image/png" href="../assets/images/documed_logo.png">
</head>
<body>
  <div class="main-wrapper">
    <nav class="top-nav">
      <div class="d-flex align-items-center">
        <div class="nav-logo"><img src="../assets/images/documed_logo.png" alt="DocuMed Logo"></div>
        <button class="nav-burger" aria-label="Toggle navigation"><span></span></button>
        <div class="nav-links">
          <a href="user_dashboard.html">Home</a>
          <!-- <a href="appointments.html">Appointment</a>
          <a href="medical_history.html">Medical History</a>
          <a href="profile.html">Profile</a> -->
          <a href="user_dashboard.html#services">Services</a>
          <a href="user_dashboard.html#about">About Us</a>
          <a href="user_dashboard.html#contact">Contact</a>
        </div>
      </div>
      <div class="nav-actions" id="navActions"></div>
    </nav>

    <div class="container" style="max-width:520px;margin:40px auto;padding:24px;background:#fff;border-radius:12px;box-shadow:0 4px 16px rgba(37,99,235,0.10)">
      <h1 class="h4 text-primary mb-3">Forgot your password?</h1>
      <p class="text-muted">Enter your Email or School ID. We'll look up your account and send a one-time code (OTP) to your registered email.</p>
      <div id="fpMsg" class="mb-2"></div>
      <form id="forgotForm">
        <div class="mb-3">
          <label for="fpIdentifier" class="form-label">Email</label>
          <input type="text" class="form-control" id="fpIdentifier" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Registered Email</label>
          <input type="email" class="form-control" id="fpLockedEmail" disabled placeholder="We will send OTP to this address" />
        </div>
        <button class="btn btn-outline-primary w-100" id="sendOtpBtn" type="button">Send OTP</button>
      </form>

      <hr class="my-4" />
      <form id="otpForm">
        <div class="mb-3">
          <label for="fpOtp" class="form-label">Enter OTP</label>
          <div class="d-flex align-items-center" style="gap:10px;">
            <input type="text" class="form-control" id="fpOtp" maxlength="6" inputmode="numeric" pattern="^[0-9]{6}$" placeholder="6-digit code" required style="flex:1;">
            <button class="btn btn-outline-secondary" id="verifyOtpBtn" type="button">Verify OTP</button>
          </div>
        </div>
        <div id="newPassWrap" style="display:none;">
          <div class="mb-3">
            <label for="fpPass" class="form-label">New password</label>
            <input type="password" class="form-control" id="fpPass" minlength="6">
          </div>
          <div class="mb-3">
            <label for="fpPass2" class="form-label">Confirm password</label>
            <input type="password" class="form-control" id="fpPass2" minlength="6">
          </div>
        </div>
        <button class="btn btn-primary w-100" id="resetBtn" type="submit" disabled>Reset password</button>
      </form>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../assets/js/mobile-nav.js"></script>
  <script>
    const idInput = document.getElementById('fpIdentifier');
    const lockedEmail = document.getElementById('fpLockedEmail');
    const sendOtpBtn = document.getElementById('sendOtpBtn');
  const msg = document.getElementById('fpMsg');

    async function lookupEmail() {
      const identifier = idInput.value.trim();
      if (!identifier) { lockedEmail.value = ''; return; }
      try {
        const res = await fetch('../../backend/api/manage_user.php?action=list&q=' + encodeURIComponent(identifier));
        const data = await res.json();
        // Find exact match by email or SID
        const users = Array.isArray(data.users) ? data.users : [];
        const lower = identifier.toLowerCase();
        const match = users.find(u => (String(u.email||'').toLowerCase()===lower) || String(u.student_faculty_id||'')===identifier) || users[0];
        lockedEmail.value = match && match.email ? match.email : '';
      } catch { lockedEmail.value = ''; }
    }
    idInput.addEventListener('blur', lookupEmail);
    idInput.addEventListener('input', ()=>{ lockedEmail.value=''; });

    sendOtpBtn.addEventListener('click', async function(){
      msg.textContent='';
      const identifier = idInput.value.trim();
      if (!identifier) { msg.className='text-danger'; msg.textContent='Enter your Email or School ID'; return; }
      // Request OTP (backend fetches email from DB and sends OTP there)
      try {
        const res = await fetch('../../backend/api/auth.php?action=request_password_otp', { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: 'identifier='+encodeURIComponent(identifier) });
        const data = await res.json();
        msg.className = data.success ? 'text-success' : 'text-danger';
        msg.textContent = data.message || (data.success ? 'If the account exists, an OTP has been sent.' : 'Request failed');
        // Do not display dev info in UI; rely on real email delivery
      } catch { msg.className='text-danger'; msg.textContent='Network error'; }
    });

    const newPassWrap = document.getElementById('newPassWrap');
    const verifyOtpBtn = document.getElementById('verifyOtpBtn');
    const resetBtn = document.getElementById('resetBtn');

    verifyOtpBtn.addEventListener('click', async function(){
      msg.textContent='';
      const identifier = idInput.value.trim();
      const otp = document.getElementById('fpOtp').value.trim();
      if (!identifier) { msg.className='text-danger'; msg.textContent='Enter your Email or School ID'; return; }
      if (!/^\d{6}$/.test(otp)) { msg.className='text-danger'; msg.textContent='Enter the 6-digit OTP.'; return; }
      try {
        const body = new URLSearchParams({ identifier, otp }).toString();
        const res = await fetch('../../backend/api/auth.php?action=verify_password_otp', { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body });
        const data = await res.json();
        msg.className = data.success ? 'text-success' : 'text-danger';
        msg.textContent = data.message || (data.success ? 'OTP verified' : 'OTP invalid');
        if (data.success) {
          newPassWrap.style.display = 'block';
          resetBtn.disabled = false;
          // Lock the identifier and OTP to prevent tampering
          idInput.readOnly = true;
          document.getElementById('fpOtp').readOnly = true;
        }
      } catch { msg.className='text-danger'; msg.textContent='Network error'; }
    });

    document.getElementById('otpForm').addEventListener('submit', async function(e){
      e.preventDefault();
      msg.textContent='';
      const identifier = idInput.value.trim();
      const otp = document.getElementById('fpOtp').value.trim();
      const pass = document.getElementById('fpPass').value;
      const pass2 = document.getElementById('fpPass2').value;
      if (!identifier) { msg.className='text-danger'; msg.textContent='Enter your Email or School ID'; return; }
      if (newPassWrap.style.display !== 'block') { msg.className='text-danger'; msg.textContent='Verify your OTP first.'; return; }
      if (pass !== pass2) { msg.className='text-danger'; msg.textContent='Passwords do not match'; return; }
      try {
        const body = new URLSearchParams({ identifier, otp, new_password: pass }).toString();
        const res = await fetch('../../backend/api/auth.php?action=reset_password_otp', { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body });
        const data = await res.json();
        msg.className = data.success ? 'text-success' : 'text-danger';
        msg.textContent = data.message || (data.success ? 'Password updated' : 'Reset failed');
        if (data.success) { setTimeout(()=>{ window.location.href = 'user_login.html'; }, 1200); }
      } catch { msg.className='text-danger'; msg.textContent='Network error'; }
    });
  </script>
</body>
</html>
