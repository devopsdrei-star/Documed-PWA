<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DocuMed</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/style.css">
  <link rel="manifest" href="../../manifest-landing.json">
  <link rel="apple-touch-icon" href="../assets/images/documed_logo.png">
  <link rel="icon" type="image/png" href="../assets/images/documed_logo.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body {
      background: #f8f9fa;
      color: #111;
    }
    .main-wrapper {
      background: #fff;
      border-radius: 0;
      box-shadow: none;
      margin: 0;
      max-width: 100%;
      width: 100%;
      min-height: 100vh;
      padding: 0;
      overflow-x: hidden;
      overflow-y: visible;
      position: relative;
    }
  .top-nav { padding: 0 24px; width: 100%; }
    .nav-links { gap: 32px; font-weight: 500; font-size: 1.08rem; }
    .nav-links a {
      color: #222;
      text-decoration: none;
      transition: color 0.2s;
    }
    .nav-links a:hover {
      color: #00d1c7;
    }
    .nav-actions {
      display: flex;
      align-items: center;
      gap: 18px;
    }
    .profile-main {
      max-width: 900px;
      margin: 48px auto 32px auto;
      padding: 0 24px;
      width: 100%;
    }
    .profile-title {
      font-size: 2rem;
      font-weight: 700;
      color: #2563eb;
      margin-bottom: 32px;
      text-align: left;
      letter-spacing: 1px;
    }
    .profile-form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 32px 36px;
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 8px 32px rgba(37,99,235,0.10);
      padding: 40px 36px 32px 36px;
    }
    .profile-form-group {
      display: flex;
      flex-direction: column;
      margin-bottom: 0;
    }
    .profile-form-group label {
      font-weight: 600;
      color: #2563eb;
      margin-bottom: 6px;
    }
    .profile-form-group input, .profile-form-group select {
      width: 100%;
      padding: 10px 14px;
      border-radius: 8px;
      border: 1.5px solid #2563eb;
      background: #fff;
      font-size: 1rem;
      margin-bottom: 0;
      transition: border 0.2s;
    }
    .profile-form-group input:focus, .profile-form-group select:focus {
      border: 1.5px solid #1742b0;
      outline: none;
    }
    .profile-photo-container {
      position: relative;
      width: 120px;
      height: 120px;
      margin: 0 auto 12px auto;
      cursor: pointer;
    }
    .profile-photo-edit {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
      display: block;
      box-shadow: 0 2px 8px #2563eb22;
      background: #fff;
      transition: filter 0.2s;
    }
    .profile-photo-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .profile-photo-container:hover .profile-photo-overlay {
      opacity: 1;
    }
    .profile-photo-container:hover .profile-photo-edit {
      filter: brightness(0.9);
    }
    .profile-photo-text {
      color: white;
      font-size: 0.85rem;
      font-weight: 500;
      text-align: center;
    }
    #photoInput {
      display: none;
    }
    .profile-actions {
      grid-column: 1 / span 2;
      display: flex;
      justify-content: flex-end;
      gap: 18px;
      margin-top: 24px;
    }
    .profile-edit-form button {
      background: #2563eb;
      color: #fff;
      padding: 12px 32px;
      border-radius: 8px;
      font-size: 1.08rem;
      box-shadow: 0 2px 8px #2563eb33;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: background 0.2s, box-shadow 0.2s;
    }
    .profile-edit-form button:hover {
      background: #1742b0;
      box-shadow: 0 4px 16px #2563eb33;
    }
    @media (max-width: 900px) {
      .profile-form-grid { grid-template-columns: 1fr; }
      .profile-actions { grid-column: 1; justify-content: center; }
    }
  </style>
</head>
<body>
  <div class="main-wrapper">
    <nav class="top-nav">
      <div class="d-flex align-items-center justify-content-between w-100">
        <div class="d-flex align-items-center">
          <div class="nav-logo">
            <img src="../assets/images/documed_logo.png" alt="DocuMed Logo">
          </div>
          <button class="nav-burger" aria-label="Toggle navigation"><span></span></button>
          <div class="nav-links" id="navLinks">
            <a href="user_dashboard.html">Home</a>
            <a href="appointments.html">Appointment</a>
            <a href="medical_history.html">Medical History</a>
            <a href="profile.html">Profile</a>
            <a href="user_dashboard.html#services" id="navServices">Services</a>
            <a href="user_dashboard.html#about" id="navAbout">About Us</a>
            <a href="user_dashboard.html#contact" id="navContact">Contact</a>
            <a href="#" id="navHelp">Help</a>
          </div>
        </div>
        <div class="nav-right">
          <div class="nav-actions" id="navActions">
            <!-- Dynamic login/profile actions here -->
          </div>
        </div>
      </div>
    </nav>
    <div class="profile-main">
      <div class="profile-title">Edit Profile</div>
      <form id="profileEditForm" class="profile-edit-form">
        <div class="profile-form-grid">
          <div class="profile-form-group">
            <label>Profile Photo</label>
            <div class="profile-photo-container" onclick="document.getElementById('photoInput').click()">
              <img id="profilePhoto" src="../../assets/images/user_photo.png" alt="Profile" class="profile-photo-edit">
              <div class="profile-photo-overlay">
                <div class="profile-photo-text">
                  <i class="bi bi-camera-fill"></i><br>
                  Change Photo
                </div>
              </div>
            </div>
            <input type="file" id="photoInput" accept="image/*" style="display:none">
          </div>
          <div class="profile-form-group">
            <label for="editEmail">Email</label>
            <input type="email" id="editEmail" name="email" required>
          </div>
          <div class="profile-form-group">
            <label for="editFirstName">First Name</label>
            <input type="text" id="editFirstName" name="first_name" required>
          </div>
          <div class="profile-form-group">
            <label for="editLastName">Last Name</label>
            <input type="text" id="editLastName" name="last_name" required>
          </div>
          <div class="profile-form-group">
            <label for="editMiddleInitial">Middle Initial</label>
            <input type="text" id="editMiddleInitial" name="middle_initial">
          </div>
          <div class="profile-form-group">
            <label for="editAge">Age</label>
            <input type="number" id="editAge" name="age">
          </div>
          <div class="profile-form-group">
            <label for="editAddress">Address</label>
            <input type="text" id="editAddress" name="address">
          </div>
          <div class="profile-form-group">
            <label for="editCivilStatus">Civil Status</label>
            <select id="editCivilStatus" name="civil_status">
              <option value="">Select civil status</option>
                <option value="Single">Single</option>
                <option value="Married">Married</option>
                <option value="Widowed">Widowed</option>
                <option value="Separated">Separated</option>
                <option value="Divorce">Divorce</option>
                <option value="Annuled">Annuled</option>
              </select>
          </div>
          <div class="profile-form-group">
            <label for="editNationality">Nationality</label>
            <input type="text" id="editNationality" name="nationality">
          </div>
          <div class="profile-form-group">
            <label for="editReligion">Religion</label>
            <input type="text" id="editReligion" name="religion">
          </div>
          <div class="profile-form-group">
            <label for="editDOB">Date of Birth</label>
            <input type="date" id="editDOB" name="date_of_birth">
          </div>
          <div class="profile-form-group">
            <label for="editPOB">Place of Birth</label>
            <input type="text" id="editPOB" name="place_of_birth">
          </div>
          <div class="profile-form-group">
            <label for="editYearCourse">Year & Course</label>
            <input type="text" id="editYearCourse" name="year_course">
          </div>
          <div class="profile-form-group">
            <label for="editID">Student/Faculty ID</label>
            <input type="text" id="editID" name="student_faculty_id" disabled>
          </div>
          <div class="profile-form-group">
            <label for="editContactPerson">Contact Person</label>
            <input type="text" id="editContactPerson" name="contact_person">
          </div>
          <div class="profile-form-group">
            <label for="editContact">Contact Number</label>
            <input type="text" id="editContact" name="contact_number">
          </div>
          <div class="profile-form-group">
            <label for="editRole">Role</label>
            <input type="text" id="editRole" name="role" readonly style="background:#f9fafb;" />
          </div>
          <div class="profile-form-group" id="departmentGroup" style="display:none;">
            <label for="editDepartment">Department</label>
            <select id="editDepartment" name="department">
              <option value="">Select Department</option>
              <option value="CCS">CCS</option>
              <option value="CASL">CASL</option>
              <option value="CBPA">CBPA</option>
              <option value="CTHM">CTHM</option>
              <option value="CTE">CTE</option>
              <option value="CIT">CIT</option>
            </select>
          </div>
        </div>
        <div class="profile-actions">
          <button type="submit">Save Changes</button>
          <div id="profileMsg" style="margin-left:18px;"></div>
        </div>
      </form>
      <!-- <div class="settings-divider" style="margin:40px 0 32px 0;"></div>
      <div id="qrLoginSection" class="profile-edit-form">
        <div class="profile-title" style="font-size:1.3rem;color:#2563eb;margin-bottom:18px;display:flex;align-items:center;gap:10px;">
          <span>QR Login</span>
          <span id="qrLoginStatus" style="font-size:0.95rem;font-weight:600;color:#059669;display:none;">Enabled</span>
        </div>
        <div class="profile-form-grid" style="grid-template-columns: 1fr 1fr;">
          <div class="profile-form-group">
            <label for="qrPassword">Confirm Password</label>
            <input type="password" id="qrPassword" placeholder="Your account password">
            <div class="form-text" style="margin-top:6px;color:#6b7280;">Weâ€™ll verify your password before enabling your personal login QR.</div>
          </div>
          <div class="profile-form-group">
            <label>Actions</label>
            <div style="display:flex;gap:10px;flex-wrap:wrap;">
              <button type="button" id="btnEnableQr" class="btn btn-primary" style="background:#2563eb;">Enable QR Login</button>
              <button type="button" id="btnDisableQr" class="btn btn-outline-danger">Disable</button>
            </div>
          </div>
          <div class="profile-form-group" style="grid-column: 1 / span 2;">
            <label>Your Personal QR</label>
            <div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap;">
              <img id="personalQrImg" src="" alt="Personal QR" style="width:140px;height:140px;border:1px solid #e5e7eb;border-radius:8px;display:none;"/>
              <div id="qrHelp" style="color:#374151;font-size:0.95rem;">
                Scan this on the login page to sign in instantly. Keep it privateâ€”treat it like a password.
              </div>
            </div>
          </div>
          <div class="profile-form-group" style="grid-column: 1 / span 2;">
            <div id="qrMsg" style="min-height:20px;"></div>
          </div>
        </div> 
      </div>-->
      <div class="settings-divider" style="margin:40px 0 32px 0;"></div>
      <form id="passwordForm" class="profile-edit-form">
        <div class="profile-title" style="font-size:1.3rem;color:#2563eb;margin-bottom:18px;">Change Password</div>
        <div class="profile-form-grid">
          <div class="profile-form-group">
            <label for="oldPassword">Current Password</label>
            <input type="password" id="oldPassword" name="oldPassword" required placeholder="Enter current password">
          </div>
          <div class="profile-form-group">
            <label for="newPassword">New Password</label>
            <input type="password" id="newPassword" name="newPassword" required placeholder="Enter new password (min 6 chars)">
          </div>
          <div class="profile-form-group">
            <label for="confirmPassword">Confirm New Password</label>
            <input type="password" id="confirmPassword" name="confirmPassword" required placeholder="Confirm new password">
          </div>
        </div>
        <div class="profile-actions">
          <button type="submit">Change Password</button>
          <div id="passwordMsg" style="margin-left:18px;"></div>
        </div>
      </form>
    </div>
  <script src="../assets/js/mobile-nav.js"></script>
  <script src="../assets/js/notifications.js"></script>
  <script src="../assets/js/pwa.js"></script>
  <script src="../assets/js/help_modal.js"></script>
  <script src="../assets/js/user_nav_profile.js"></script>
  <script src="../assets/js/profile.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode/html5-qrcode.min.js"></script>
  <script src="../assets/js/user_dashboard.js"></script>
  <!-- dashboard helpers not needed here; profile nav handled by user_nav_profile.js -->

  <!-- Approve Login / QR View Modals so View Patient QR Code & Scan QR work like dashboard -->
  <div class="modal fade" id="approveModal" tabindex="-1" aria-labelledby="approveModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content" style="border-radius:16px;">
        <div class="modal-header" style="background:#2563eb;color:#fff;border-radius:16px 16px 0 0;">
          <h5 class="modal-title" id="approveModalLabel">Scan to Approve Login</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="approveMsg" class="text-muted mb-2">Point your camera at the QR code on the desktop login.</div>
          <div class="scan-box" id="scanBox" style="position:relative;width:100%;border:1px solid #e5e7eb;border-radius:10px;overflow:hidden;background:#000;">
            <div id="approveReader"></div>
            <video id="approveVideo" playsinline style="display:none;width:100%;"></video>
            <div class="scan-overlay" id="scanOverlay" style="position:absolute;inset:0;pointer-events:none;display:none;">
              <div class="scan-line" style="position:absolute;left:8%;right:8%;height:3px;border-radius:2px;background:linear-gradient(90deg,transparent,#22c55e,#22c55e,transparent);box-shadow:0 0 8px #22c55e;animation:scanY 2.2s linear infinite;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content" style="border-radius:16px;">
        <div class="modal-header" style="background:#2563eb;color:#fff;border-radius:16px 16px 0 0;">
          <h5 class="modal-title" id="confirmModalLabel">Confirm Login</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="confirmMsg" class="text-muted mb-2"></div>
          <div class="card" style="border:1px solid #e5e7eb;">
            <div class="card-body">
              <div class="mb-2" style="font-weight:700;">Is this you?</div>
              <div id="confirmDevice" class="mb-2" style="color:#334155;">Device: â€”</div>
              <div class="text-muted" style="font-size:0.92rem;">Are you trying to log in on this computer?</div>
              <div class="d-flex gap-2 mt-3">
                <button type="button" id="confirmYes" class="btn btn-success">Yes, log me in</button>
                <button type="button" id="confirmCancel" class="btn btn-outline-secondary">Cancel</button>
              </div>
            </div>
          </div>
          <div id="confirmCreds" style="display:none;margin-top:12px;">
            <div class="mb-2" style="font-weight:600;color:#0f172a;">Approve with your password</div>
            <div class="row g-2">
              <div class="col-12 col-md-6">
                <input type="text" id="confirmIdentifier" class="form-control" placeholder="Email or School ID" />
              </div>
              <div class="col-12 col-md-6">
                <input type="password" id="confirmPassword" class="form-control" placeholder="Password" />
              </div>
            </div>
            <div class="d-flex justify-content-between mt-2 flex-wrap" style="gap:8px;">
              <button type="button" id="enablePersonalNow2" class="btn btn-outline-secondary btn-sm">Enable Oneâ€‘Tap Approval</button>
              <div class="ms-auto"></div>
              <button type="button" id="confirmSubmit" class="btn btn-primary btn-sm">Approve</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="qrModal" tabindex="-1" aria-labelledby="qrModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border-radius:16px;">
      <div class="modal-header" style="background:#2563eb;color:#fff;border-radius:16px 16px 0 0;">
        <h5 class="modal-title" id="qrModalLabel">Patient Info QR Code</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
           <img id="userQRImg" src="" alt="User QR Code" 
             style="width:180px;height:180px;object-fit:contain;margin-bottom:12px;">
           <div id="qrLabel" style="font-size:1.08rem;color:#000000;font-weight:600;margin-bottom:4px;"></div>
           <div id="qrMsg" class="text-danger" style="margin-top:8px;"></div>
           <button id="qrGenerateBtn" type="button" class="btn btn-primary btn-sm" style="margin-top:8px;display:none;">Enable QR Login</button>
      </div>
    </div>
  </div>
</div>
  <script>
    (function(){
      const modalEl = document.getElementById('approveModal');
      if (!modalEl) return;
      const approveMsg = document.getElementById('approveMsg');
      let qrObj = null;
      let video = document.getElementById('approveVideo');
      let stream = null;
      let rafId = null;
      let detector = null;
      let scannedChallenge = '';

      function stopCam(){
        if (qrObj) { try { qrObj.stop().catch(()=>{}); } catch(_) {} qrObj = null; }
        if (rafId) { cancelAnimationFrame(rafId); rafId = null; }
        if (video) { try { video.pause(); } catch(_) {} video.srcObject = null; }
        if (stream) { try { stream.getTracks().forEach(t=>t.stop()); } catch(_) {} stream = null; }
        detector = null;
        const scanOverlay = document.getElementById('scanOverlay');
        if (scanOverlay) scanOverlay.style.display = 'none';
      }

      function handleScannedText(txt){
        try {
          const parts = (txt||'').split(':');
          let challenge = txt;
          if (parts.length >= 3 && parts[0].toUpperCase()==='DMQR' && (parts[1].toLowerCase()==='chlg' || parts[1].toLowerCase()==='v1')) challenge = (parts[2] || parts[parts.length-1] || '').trim();
          challenge = (challenge || '').trim();
          scannedChallenge = challenge;
          stopCam();
          const scanModal = bootstrap.Modal.getOrCreateInstance(document.getElementById('approveModal'));
          scanModal.hide();
          const cmEl = document.getElementById('confirmModal');
          const cm = bootstrap.Modal.getOrCreateInstance(cmEl);
          const cMsg = document.getElementById('confirmMsg');
          const cDev = document.getElementById('confirmDevice');
          const cCreds = document.getElementById('confirmCreds');
          if (cCreds) cCreds.style.display = 'none';
          if (cMsg) cMsg.textContent = 'Fetching device info...';
          cm.show();
          fetch('../../backend/api/auth.php?action=qr_challenge_info', { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: 'challenge=' + encodeURIComponent(challenge) })
            .then(r=>r.json())
            .then(d=>{
              if (d && d.success) {
                if (cMsg) cMsg.textContent = 'Review and confirm login';
                if (cDev) cDev.textContent = 'Device: ' + (d.ua_summary || 'Browser');
              } else {
                if (cMsg) cMsg.textContent = (d && (d.message||d.error)) || 'Unable to fetch device info.';
              }
            })
            .catch(()=>{ if (cMsg) cMsg.textContent = 'Network error getting info.'; });
        } catch (e) { if (approveMsg) approveMsg.textContent = 'Error processing scan.'; }
      }

      function tryStart(){
        if (approveMsg) approveMsg.textContent = 'Loading camera...';
        const scanOverlay = document.getElementById('scanOverlay');
        const start = async () => {
          try {
            if ('BarcodeDetector' in window) {
              try { detector = new window.BarcodeDetector({ formats: ['qr_code'] }); } catch (_) { detector = null; }
            }
            if (detector) {
              stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
              if (!video) video = document.getElementById('approveVideo');
              const reader = document.getElementById('approveReader');
              if (reader) reader.style.display = 'none';
              video.style.display = 'block';
              video.srcObject = stream;
              await video.play();
              if (approveMsg) approveMsg.textContent = 'Camera ready. Scan the QR on desktop.';
              if (scanOverlay) scanOverlay.style.display = 'block';
              const scanLoop = async () => {
                try {
                  const codes = await detector.detect(video);
                  if (codes && codes.length) {
                    const txt = codes[0].rawValue || '';
                    if (approveMsg) approveMsg.textContent = 'Scanning, Waiting to Approve...';
                    handleScannedText(txt);
                    return;
                  }
                } catch(_) {}
                rafId = requestAnimationFrame(scanLoop);
              };
              rafId = requestAnimationFrame(scanLoop);
              return;
            }
            const html5 = window.Html5Qrcode;
            if (!html5) { if (approveMsg) approveMsg.textContent = 'QR engine not available.'; return; }
            qrObj = new html5('approveReader');
            qrObj.start({ facingMode:'environment' }, { fps:10, qrbox: { width:250, height:250 } }, (txt)=>{
              if (approveMsg) approveMsg.textContent = 'Naka-scan. Nag-a-approve...';
              handleScannedText(txt);
            }, ()=>{}).catch(()=>{ if (approveMsg) approveMsg.textContent = 'Camera not available.'; });
          } catch (e) { if (approveMsg) approveMsg.textContent = 'Unable to start camera.'; }
        };
        if (window.loadHtml5Qr) {
          window.loadHtml5Qr().then(start).catch(()=>{ if (approveMsg) approveMsg.textContent = 'QR engine not available.'; });
        } else {
          const tryLoad = (url) => new Promise((resolve, reject) => {
            const s=document.createElement('script'); s.src=url; s.async=true; s.onload=()=>resolve(); s.onerror=()=>reject(); document.head.appendChild(s); setTimeout(()=>reject(),8000);
          });
          const urls = [
            '../assets/js/vendor/html5-qrcode.min.js',
            '/documed_pwa/frontend/assets/js/vendor/html5-qrcode.min.js',
            '/DocMed/documed_pwa/frontend/assets/js/vendor/html5-qrcode.min.js',
            'https://cdn.jsdelivr.net/npm/html5-qrcode/html5-qrcode.min.js',
            'https://unpkg.com/html5-qrcode/html5-qrcode.min.js'
          ];
          urls.reduce((p,u)=>p.catch(()=>tryLoad(u)), Promise.reject())
            .then(()=>start())
            .catch(()=>{ if (approveMsg) approveMsg.textContent = 'QR engine not available.'; });
        }
      }

      document.body.addEventListener('click', function(e){
        const t = e.target && e.target.closest && e.target.closest('#scanApproveBtn');
        if (!t) return;
        e.preventDefault();
        const m = bootstrap.Modal.getOrCreateInstance(modalEl);
        m.show();
      });
      modalEl.addEventListener('shown.bs.modal', tryStart);
      modalEl.addEventListener('hidden.bs.modal', stopCam);

      document.addEventListener('click', async function(ev){
        if (!(ev.target && ev.target.id === 'confirmYes')) return;
        ev.preventDefault();
        const cMsg = document.getElementById('confirmMsg');
        if (!scannedChallenge) { if (cMsg) cMsg.textContent = 'No challenge scanned.'; return; }
        const personal = localStorage.getItem('documed_personal_qr') || '';
        if (personal) {
          if (cMsg) cMsg.textContent = 'Approving...';
          const params = new URLSearchParams(); params.set('challenge', scannedChallenge); params.set('qr', personal);
          try {
            const r = await fetch('../../backend/api/auth.php?action=qr_approve_challenge', { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: params.toString() });
            const d = await r.json();
            if (d && d.success) {
              if (cMsg) cMsg.textContent = 'Approved! You can now continue on desktop.';
              const cmEl = document.getElementById('confirmModal');
              if (cmEl) bootstrap.Modal.getOrCreateInstance(cmEl).hide();
            } else {
              if (cMsg) cMsg.textContent = (d&&(d.message||d.error)) || 'Approval failed';
            }
          } catch(_) { if (cMsg) cMsg.textContent = 'Network error'; }
          return;
        }
        if (sessionStorage.getItem('documedLoggedIn') === '1') {
          if (cMsg) cMsg.textContent = 'Approving...';
          const params = new URLSearchParams(); params.set('challenge', scannedChallenge);
          try {
            const r = await fetch('../../backend/api/auth.php?action=qr_approve_challenge', { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: params.toString() });
            const d = await r.json();
            if (d && d.success) {
              if (cMsg) cMsg.textContent = 'Approved! You can now continue on desktop.';
              const cmEl = document.getElementById('confirmModal');
              if (cmEl) bootstrap.Modal.getOrCreateInstance(cmEl).hide();
              return;
            } else {
              if (cMsg) cMsg.textContent = (d&&(d.message||d.error)) || 'Password is required for approval.';
            }
          } catch(_) { if (cMsg) cMsg.textContent = 'Network error, please enter password.'; }
        }
        const creds = document.getElementById('confirmCreds');
        if (creds) creds.style.display = 'block';
        if (cMsg) cMsg.textContent = 'No personal QR token. You can enter your email/ID and password to approve.';
        try {
          const u = JSON.parse(localStorage.getItem('documed_user')||'null');
          const idEl = document.getElementById('confirmIdentifier');
          if (u && idEl) idEl.value = u.email || u.student_faculty_id || '';
          const pwEl = document.getElementById('confirmPassword');
          if (pwEl) pwEl.focus();
        } catch(_) {}
      });

      document.addEventListener('click', async function(ev){
        if (!(ev.target && ev.target.id === 'confirmCancel')) return;
        ev.preventDefault();
        const cMsg = document.getElementById('confirmMsg');
        if (!scannedChallenge) { if (cMsg) cMsg.textContent = 'No challenge scanned.'; return; }
        if (cMsg) cMsg.textContent = 'Cancelling...';
        try {
          const r = await fetch('../../backend/api/auth.php?action=qr_cancel_challenge', { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: 'challenge=' + encodeURIComponent(scannedChallenge) });
          const d = await r.json();
          if (cMsg) cMsg.textContent = (d && d.success) ? 'Cancelled.' : ((d&&(d.message||d.error)) || 'Failed to cancel');
        } catch(_) { if (cMsg) cMsg.textContent = 'Network error'; }
      });

      document.addEventListener('click', function(ev){
        if (!(ev.target && ev.target.id === 'confirmSubmit')) return;
        ev.preventDefault();
        const cMsg = document.getElementById('confirmMsg');
        const idEl = document.getElementById('confirmIdentifier');
        const pwEl = document.getElementById('confirmPassword');
        const identifier = (idEl && idEl.value || '').trim();
        const password = (pwEl && pwEl.value || '').trim();
        if (!identifier || !password) { if (cMsg) cMsg.textContent = 'Please enter both email/ID and password.'; return; }
        if (!scannedChallenge) { if (cMsg) cMsg.textContent = 'No challenge scanned. Scan again the QR on the desktop.'; return; }
        if (cMsg) cMsg.textContent = 'Sending approval...';
        const params = new URLSearchParams();
        params.set('challenge', scannedChallenge);
        params.set('identifier', identifier);
        params.set('password', password);
        fetch('../../backend/api/auth.php?action=qr_approve_challenge', { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: params.toString() })
          .then(r=>r.json())
          .then(d=>{
            if (d && d.success) {
              if (cMsg) cMsg.textContent = 'Approved! You can now continue on desktop.';
              const cmEl = document.getElementById('confirmModal');
              if (cmEl) bootstrap.Modal.getOrCreateInstance(cmEl).hide();
            } else {
              if (cMsg) cMsg.textContent = (d&&(d.message||d.error)) || 'Approval failed';
            }
          })
          .catch(()=>{ if (cMsg) cMsg.textContent = 'Network error'; });
      });

      document.addEventListener('click', async function(ev){
        if (!(ev.target && ev.target.id === 'enablePersonalNow2')) return;
        ev.preventDefault();
        const cMsg = document.getElementById('confirmMsg');
        const idEl = document.getElementById('confirmIdentifier');
        const pwEl = document.getElementById('confirmPassword');
        const identifier = (idEl && idEl.value || '').trim();
        const password = (pwEl && pwEl.value || '').trim();
        if (!identifier || !password) { if (cMsg) cMsg.textContent = 'Please enter both email/ID and password.'; return; }
        if (cMsg) cMsg.textContent = 'Enabling oneâ€‘tap approval...';
        try {
          const body = new URLSearchParams({ identifier, password }).toString();
          const res = await fetch('../../backend/api/auth.php?action=qr_generate_token', { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body });
          const text = await res.text();
          let data; try { data = JSON.parse(text); } catch(e){ data=null; }
          if (data && data.success && data.qr_text) {
            try { localStorage.setItem('documed_personal_qr', data.qr_text); } catch(_) {}
            if (cMsg) cMsg.textContent = 'Oneâ€‘tap approval enabled. Approving now...';
            if (scannedChallenge) {
              const params = new URLSearchParams(); params.set('challenge', scannedChallenge); params.set('qr', data.qr_text);
              const r = await fetch('../../backend/api/auth.php?action=qr_approve_challenge', { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: params.toString() });
              const rt = await r.text(); let rd; try { rd = JSON.parse(rt); } catch(e){ rd=null; }
              if (rd && rd.success) {
                if (cMsg) cMsg.textContent = 'Approved! You can now continue on desktop.';
                const cmEl = document.getElementById('confirmModal');
                if (cmEl) bootstrap.Modal.getOrCreateInstance(cmEl).hide();
              } else {
                if (cMsg) cMsg.textContent = (rd && (rd.message||rd.error)) || 'Approval failed';
              }
            } else {
              if (cMsg) cMsg.textContent = 'Enabled. Next scans will autoâ€‘approve.';
            }
          } else {
            if (cMsg) cMsg.textContent = (data && (data.message||data.error)) || 'Failed to enable oneâ€‘tap approval.';
          }
        } catch(err) {
          if (cMsg) cMsg.textContent = 'Network or server error while enabling.';
        }
      });

      document.addEventListener('keydown', function(ev){
        const pwEl = document.getElementById('confirmPassword');
        if (!pwEl) return;
        if (document.activeElement === pwEl && ev.key === 'Enter') {
          ev.preventDefault();
          const btn = document.getElementById('confirmSubmit');
          if (btn) btn.click();
        }
      });
    })();

    document.addEventListener('DOMContentLoaded', function() {
      // View QR pop-up
      const qrModalEl = document.getElementById('qrModal');
      const qrImgEl = document.getElementById('userQRImg');
      const qrLabelEl = document.getElementById('qrLabel');
      // Ensure a single modal instance is reused
      let qrModal = bootstrap.Modal.getOrCreateInstance(qrModalEl, { backdrop: true, keyboard: true });
      // Clean up any leftover backdrops/body state on hide (safety net)
      qrModalEl.addEventListener('hidden.bs.modal', function(){
        document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
        document.body.classList.remove('modal-open');
        document.body.style.removeProperty('padding-right');
        // Reset QR content to avoid flashes
        if (qrImgEl) qrImgEl.src = '';
        if (qrLabelEl) qrLabelEl.textContent = '';
      });

      document.body.addEventListener('click', function(e) {
        if (e.target && e.target.id === 'viewQRBtn') {
          e.preventDefault();
          // Close any open dropdowns before showing modal
          document.querySelectorAll('.dropdown-toggle[aria-expanded="true"]').forEach(function(t){
            try { bootstrap.Dropdown.getOrCreateInstance(t).hide(); } catch(_) {}
          });

          // Get user QR from backend
          let userObj = null;
          try {
            userObj = JSON.parse(localStorage.getItem('documed_user'));
          } catch (e) {}
          
          let userId = userObj && userObj.id ? userObj.id : localStorage.getItem('id');
          if (!userId) userId = localStorage.getItem('student_faculty_id');
          const genBtn = document.getElementById('qrGenerateBtn');
          const msg = document.getElementById('qrMsg');
          if (msg) { msg.textContent = ''; msg.classList.remove('text-success'); msg.classList.add('text-danger'); }
          
          fetch(`../../backend/api/auth.php?action=get_user`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `id=${encodeURIComponent(userId)}`
          })
          .then(res => res.json())
          .then(data => {
            if (qrImgEl && qrLabelEl) {
              if (data.success && data.user && data.user.qr_code) {
                qrImgEl.src = data.user.qr_code;
                qrLabelEl.textContent = userObj ? (userObj.name || '') : '';
                if (genBtn) genBtn.style.display = 'none';
              } else {
                qrImgEl.src = '../assets/images/documed_logo.png';
                qrLabelEl.textContent = 'No QR code found.';
                if (genBtn) {
                  genBtn.style.display = 'inline-block';
                  genBtn.onclick = function(){
                    if (msg) { msg.textContent = 'Generating secure QR...'; msg.classList.remove('text-danger'); msg.classList.add('text-muted'); }
                    fetch(`../../backend/api/auth.php?action=qr_generate_token`, {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                      body: `id=${encodeURIComponent(userId)}`
                    })
                    .then(r => r.json())
                    .then(resp => {
                      if (resp && resp.success) {
                        // Set image to new QR, or refetch user if only path provided
                        if (resp.qr_image) {
                          qrImgEl.src = resp.qr_image + '?t=' + Date.now();
                        } else if (resp.user && resp.user.qr_code) {
                          qrImgEl.src = resp.user.qr_code + '?t=' + Date.now();
                        } else {
                          // Fallback: refetch user
                          return fetch(`../../backend/api/auth.php?action=get_user`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                            body: `id=${encodeURIComponent(userId)}`
                          }).then(rr => rr.json()).then(dd => {
                            if (dd && dd.success && dd.user && dd.user.qr_code) {
                              qrImgEl.src = dd.user.qr_code + '?t=' + Date.now();
                            }
                          });
                        }
                        if (msg) { msg.textContent = 'QR Login enabled.'; msg.classList.remove('text-danger','text-muted'); msg.classList.add('text-success'); }
                        if (genBtn) genBtn.style.display = 'none';
                      } else {
                        if (msg) { msg.textContent = (resp && (resp.message || resp.error)) || 'Failed to generate QR.'; msg.classList.remove('text-success','text-muted'); msg.classList.add('text-danger'); }
                      }
                    })
                    .catch(()=>{
                      if (msg) { msg.textContent = 'Error contacting server.'; msg.classList.remove('text-success','text-muted'); msg.classList.add('text-danger'); }
                    });
                  };
                }
              }
            }
          });
          
          qrModal.show();
        }
      });
    });
  </script>
  </body>
  <!-- AI Chatbot Floating Button and Chat Window -->
  <div id="aiChatbotBtn" style="position:fixed;bottom:100px;right:32px;z-index:9999;">
    <button style="background:#2563eb;color:#fff;border:none;border-radius:50%;width:60px;height:60px;box-shadow:0 4px 16px rgba(37,99,235,0.18);font-size:2rem;cursor:pointer;" title="Chat with AI">
      ðŸ’¬
    </button>
  </div>
  <div id="aiChatbotWindow" style="display:none;position:fixed;bottom:170px;right:32px;width:350px;max-width:95vw;height:480px;z-index:10000;background:#fff;border-radius:16px;box-shadow:0 8px 32px rgba(37,99,235,0.18);overflow:hidden;flex-direction:column;">
    <div style="background:#2563eb;color:#fff;padding:16px 20px;font-weight:600;font-size:1.1rem;display:flex;align-items:center;justify-content:space-between;">
      <span>Documed Chatbot</span>
      <button id="aiChatbotClose" style="background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer;">&times;</button>
    </div>
    <div id="aiChatbotMessages" style="flex:1;overflow-y:auto;padding:16px 12px 12px 12px;height:340px;background:#f8fafc;"></div>
    <form id="aiChatbotForm" style="display:flex;padding:12px 12px 12px 12px;background:#f3f6fc;gap:8px;">
      <input id="aiChatbotInput" type="text" placeholder="Type your question..." style="flex:1;padding:10px 14px;border-radius:8px;border:1.5px solid #2563eb;font-size:1rem;outline:none;" required autocomplete="off" />
      <button type="submit" style="background:#2563eb;color:#fff;border:none;border-radius:8px;padding:0 18px;font-size:1rem;font-weight:600;">Send</button>
    </form>
  </div>
  <script>
    // AI Chatbot UI logic
    const aiBtn = document.getElementById('aiChatbotBtn');
    const aiWin = document.getElementById('aiChatbotWindow');
    const aiClose = document.getElementById('aiChatbotClose');
    aiBtn.onclick = () => { aiWin.style.display = 'flex'; };
    aiClose.onclick = () => { aiWin.style.display = 'none'; };
    // Minimize on outside click
    document.addEventListener('mousedown', function(e) {
      if (aiWin.style.display === 'flex' && !aiWin.contains(e.target) && !aiBtn.contains(e.target)) {
        aiWin.style.display = 'none';
      }
    });
    // Chatbot messaging logic (OpenAI integration to be added next)
    const aiForm = document.getElementById('aiChatbotForm');
    const aiInput = document.getElementById('aiChatbotInput');
    const aiMsgs = document.getElementById('aiChatbotMessages');
    function appendMsg(sender, text) {
      const div = document.createElement('div');
      div.style.margin = '8px 0';
      div.style.textAlign = sender === 'user' ? 'right' : 'left';
      div.innerHTML = `<span style="display:inline-block;max-width:80%;padding:10px 14px;border-radius:12px;background:${sender==='user'?'#2563eb':'#e0e7ff'};color:${sender==='user'?'#fff':'#222'};font-size:1rem;">${text.replace(/</g,'&lt;')}</span>`;
      aiMsgs.appendChild(div);
      aiMsgs.scrollTop = aiMsgs.scrollHeight;
    }
    aiForm.onsubmit = function(e) {
      e.preventDefault();
      const msg = aiInput.value.trim();
      if (!msg) return;
      appendMsg('user', msg);
      aiInput.value = '';
      // Call backend to get OpenAI response
      fetch('../../backend/api/chatbot.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: msg })
      })
      .then(res => res.json())
      .then(data => {
        // Remove placeholder
        aiMsgs.lastChild.remove();
        if (data.reply) {
          appendMsg('ai', data.reply);
        } else {
          appendMsg('ai', data.error || 'Sorry, I could not get a response.');
        }
      })
      .catch(() => {
        aiMsgs.lastChild.remove();
        appendMsg('ai', 'Network error. Please try again.');
      });
    };
  </script>
  <footer style="background:#0a6ecb;color:#fff;padding:32px 0 18px 0;margin-top:48px;width:100vw;">
    <div style="max-width:1100px;margin:auto;display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center;">
      <div id="footerClinicName" style="font-size:1.15rem;font-weight:600;letter-spacing:1px;">DocuMed Campus Clinic &copy; 2025</div>
      <div style="font-size:1rem;">For inquiries: <a href="mailto:clinic@documed.com" style="color:#fff;text-decoration:underline;">clinic@documed.com</a></div>
      <div style="font-size:1rem;">Powered by <span style="color:#00d1c7;font-weight:600;">DocuMed</span></div>
    </div>
  </footer>
</html>
