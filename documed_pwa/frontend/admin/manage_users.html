<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DocuMed</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/style.css?v=docnurse2">
  <link rel="stylesheet" href="../assets/css/docnurse_layout.css?v=1">
  <link rel="icon" type="image/png" href="../assets/images/documed_logo.png" />
  <style>
    body {
    background: #f3f4f6; 
    color: #111; 
    }
    .main-content { 
    background: #fff; 
    box-shadow: 0 8px 32px rgba(37,99,235,0.14); 
    }
    h1 { 
        color: #111; 
        font-size: 2rem; 
        margin-bottom: 24px; 
        text-align: center; 
        letter-spacing: 1px; 
        font-weight: 700; 
        text-shadow: 0 2px 8px rgba(37,99,235,0.08); 
    }
    #users-list { 
        overflow-x: auto; 
        margin-top: 12px; 
    }
    #usersTable { 
        width: 100%; 
        border-collapse: separate; 
        border-spacing: 0; 
        background: #fff; 
        box-shadow: 0 4px 16px rgba(37,99,235,0.08); 
        border-radius: 12px; 
        overflow: hidden; 
    }
    #usersTable th, #usersTable td { 
        padding: 7px 7px; 
        text-align: left; 
        color: #111; 
        font-size: 0.92rem; 
        border-bottom: 1px solid #e5e7eb; 
        background: #fff; }
    #usersTable th { 
        background: #f3f4f6; 
        font-weight: 600; 
        letter-spacing: 0.5px; 
        color: #111; 
        border-bottom: 2px solid #2563eb;
    }
    #usersTable tr:last-child td { 
        border-bottom: none; 
    }
    .sidebar { 
        box-shadow: 0 4px 24px rgba(37,99,235,0.10); 
    }
    .profile-photo {
        box-shadow: 0 2px 8px rgba(37,99,235,0.10); 
    }
    .sidebar-link.active { 
        background: #1e40af; 
        color: #ffffff !important; 
        box-shadow: 0 2px 8px rgba(37,99,235,0.10); 
    }
    .sidebar-link { 
        color: #ffffff; 
        font-weight: 500; 
    }
    .logout { 
        color: #fff !important; 
        box-shadow: 0 2px 8px rgba(239,68,68,0.10); 
    }
    @media (max-width: 900px) { 
        .main-content { padding: 18px 4px; } 
        #usersTable th, #usersTable td { padding: 8px 4px; font-size: 0.92rem; } 
    }

    
  </style>
</head>
<body>
  <div class="admin-layout" style="box-shadow: 0 8px 32px rgba(37,99,235,0.18); border-radius: 18px; width: 100vw; min-height: 100vh; margin: 0; max-width: none;">
    <aside class="sidebar">
  <div class="logo"><img src="../assets/images/documed_logo.png" alt="DocuMed" /></div>
          <nav class="sidebar-nav">
    <a href="dashboard.html" class="sidebar-link"><i class="bi bi-speedometer2 me-2"></i>Dashboard</a>
    <a href="patients.html" class="sidebar-link"><i class="bi bi-people me-2"></i>Patients</a>
    <a href="appointments.html" class="sidebar-link"><i class="bi bi-calendar-check me-2"></i>Appointments</a>
    <a href="manage_users.html" class="sidebar-link active"><i class="bi bi-person-gear me-2"></i>Manage user</a>
    <a href="audit_trail.html" class="sidebar-link"><i class="bi bi-clock-history me-2"></i>Activity log</a> 
    <a href="medicine_inventory.html" class="sidebar-link"><i class="bi bi-capsule me-2"></i>Medicine</a>
  <a href="reports.html" class="sidebar-link"><i class="bi bi-graph-up me-2"></i>Reports</a>
  <a href="settings.html" class="sidebar-link"><i class="bi bi-gear me-2"></i>Settings</a>
      </nav>
    </aside>
     <main class="main-content">
  <div class="dashboard-topbar" style="display:flex;justify-content:flex-end;align-items:center;margin-bottom:18px;gap:18px;">
    <button id="dashboardSettingsBtn" style="background:none;border:none;cursor:pointer;font-size:1.7rem;color:#2563eb;display:flex;align-items:center;">
    </button>
    <div class="dashboard-profile-dropdown" style="position:relative;">
      <button id="dashboardProfileBtn" style="background:none;border:none;cursor:pointer;display:flex;align-items:center;gap:8px;">
  <img src="../assets/images/documed_logo.png" alt="DocuMed Logo" style="width:38px;height:38px;border-radius:50%;object-fit:cover;box-shadow:0 2px 8px #2563eb22;">
      </button>
      <div id="dashboardProfileMenu" style="display:none;position:absolute;right:0;top:110%;background:#fff;box-shadow:0 2px 8px #2563eb22;border-radius:10px;min-width:160px;z-index:20;">
        <a href="#" id="profileInfoMenu" style="display:block;padding:12px 18px;color:#2563eb;text-decoration:none;font-weight:500;border-bottom:1px solid #f3f4f6;">Profile Info</a>
        <a href="admin_login.html" id="logoutMenu" style="display:block;padding:12px 18px;color:#e11d48;text-decoration:none;font-weight:500;">Logout</a>
      </div>
    </div>
  </div>
        <div class="patients-topbar" style="display:flex;justify-content:flex-end;align-items:center;margin-bottom:18px;gap:18px;"></div>
        <h1 class="mb-4">Manage Users</h1>
    <div class="mb-2 d-flex flex-wrap gap-2" style="max-width: 100%; align-items: center;">
      <input type="text" id="searchUser" class="form-control" placeholder="Search user by name/email/ID..." autocomplete="off" style="height:44px; max-width: 380px;">
      <select id="roleFilter" class="form-select" style="height:44px; width: 180px;">
        <option value="All">All Roles</option>
        <option value="Student">Student</option>
        <option value="Teacher">Teacher</option>
        <option value="Non-Teaching">Non-Teaching</option>
        <option value="Doctor">Doctor</option>
        <option value="Dentist">Dentist</option>
        <option value="Nurse">Nurse</option>
        <option value="Admin">Admin</option>
      </select>
      <select id="statusFilter" class="form-select" style="height:44px; width: 180px;">
        <option value="All">All Status</option>
        <option value="active">Active</option>
        <option value="inactive">Inactive</option>
        <option value="archived">Archived</option>
      </select>
        <button type="button" id="refreshBtn" class="btn btn-primary" style="height:44px;">Refresh</button>
      <div class="ms-auto d-flex gap-2">
        <button type="button" class="btn btn-primary" style="height:44px;" data-bs-toggle="modal" data-bs-target="#addUserModal">Add User</button>
      </div>
    </div>
        <ul id="searchSuggestions" class="list-group position-absolute" style="z-index:9000; max-width:400px; display:none;"></ul>
        <div id="users-list">
          <table id="usersTable">
            <thead>
              <tr>
                <th>School ID</th>
                <th>Name</th>
                <th>Email</th>
                <th>Role</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <!-- Users will be injected here -->
            </tbody>
          </table>
          <!-- <nav aria-label="Users pagination" class="mt-3">
            <div class="d-flex justify-content-center align-items-center gap-2" id="usersPaginationContainer" style="margin-top:18px;">
              <button id="usersPrev" class="btn btn-sm" style="width:20px;height:20px;background:#9ca3af;color:#fff;border:none;border-radius:8px;display:flex;align-items:center;justify-content:center;" aria-label="Previous" aria-disabled="true" disabled>
                <i class="bi bi-chevron-left"></i>
              </button>
              <span id="usersPageInfo" class="fw-semibold" style="font-size:1rem;">Page 1 of 1</span>
              <button id="usersNext" class="btn btn-sm" style="width: 20px;height:20px;background:#2563eb;color:#fff;border:none;border-radius:8px;display:flex;align-items:center;justify-content:center;" aria-label="Next" aria-disabled="true" disabled>
                <i class="bi bi-chevron-right"></i>
              </button> -->
                <div id="usersPaginationContainer" style="display:none;align-items:center;gap:12px;justify-content:center;margin-top:12px;">
                  <button id="usersPrev" style="background:#6b7280;color:#fff;padding:6px 12px;border:none;border-radius:6px;cursor:pointer;">&#9664;</button>
                  <span id="usersPageInfo" style="font-size:0.9rem;color:#374151;"></span>
                  <button id="usersNext" style="background:#2563eb;color:#fff;padding:6px 12px;border:none;border-radius:6px;cursor:pointer;">&#9654;</button>
                </div>
            </div>
          </nav>
        </div>
      </div>
      <!-- Add Modal -->
      <div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="addUserModalLabel">Add User/Admin</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="addUserForm">
              <div class="modal-body">
                <div class="mb-3">
                  <label for="addEntityType" class="form-label">Type</label>
                  <select class="form-select" id="addEntityType">
                    <option value="user" selected>User</option>
                    <option value="admin">Admin</option>
                  </select>
                </div>
                <div id="adminHint" class="text-muted small" style="display:none;margin-top:-6px;margin-bottom:8px;">Admins do not use School ID, and will be created in the admins table.</div>
                <div class="mb-3">
                  <label for="addUserSchoolId" class="form-label">School ID</label>
                  <input type="text" class="form-control" id="addUserSchoolId" required>
                </div>
                <div class="mb-3">
                  <label for="addUserLastName" class="form-label">Last Name</label>
                  <input type="text" class="form-control" id="addUserLastName" required>
                </div>
                <div class="mb-3">
                  <label for="addUserFirstName" class="form-label">First Name</label>
                  <input type="text" class="form-control" id="addUserFirstName" required>
                </div>
                <div class="mb-3">
                  <label for="addUserMiddleInitial" class="form-label">Middle Initial</label>
                  <input type="text" class="form-control" id="addUserMiddleInitial" maxlength="1">
                </div>
                <div class="mb-3">
                  <label for="addUserEmail" class="form-label">Email</label>
                  <input type="email" class="form-control" id="addUserEmail" required>
                </div>
                <div class="mb-3">
                  <label for="addUserRole" class="form-label">Client Type</label>
                  <select class="form-select" id="addUserRole" required>
                    <!-- Options populated dynamically (Dentist, Student/Faculty/Staff) -->
                  </select>
                </div>
                <div class="mb-3" id="addUserGenderGroup" style="display:none;">
                  <label for="addUserGender" class="form-label">Gender</label>
                  <select class="form-select" id="addUserGender">
                    <option value="">Select gender</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                  </select>
                </div>
                <div class="mb-3" id="addUserDobGroup" style="display:none;">
                  <label for="addUserDob" class="form-label">Date of Birth</label>
                  <input type="date" class="form-control" id="addUserDob" max="" placeholder="YYYY-MM-DD">
                  <div class="form-text" id="addUserAgePreview" style="margin-top:4px;color:#2563eb;font-weight:500;display:none;"></div>
                </div>
                <div class="mb-3" id="addUserYearCourseGroup" style="display:none;">
                  <label for="addUserYearCourse" class="form-label">Year & Course</label>
                  <input type="text" class="form-control" id="addUserYearCourse" placeholder="e.g., 3rd Year BSIT">
                </div>
                <div class="mb-3" id="addUserDepartmentGroup" style="display:none;">
                  <label for="addUserDepartment" class="form-label">Department</label>
                  <select class="form-select" id="addUserDepartment">
                    <option value="">Select Department</option>
                    <option value="CCS">CCS</option>
                    <option value="CASL">CASL</option>
                    <option value="CBPA">CBPA</option>
                    <option value="CTHM">CTHM</option>
                    <option value="CTE">CTE</option>
                    <option value="CIT">CIT</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label for="addUserStatus" class="form-label">Status</label>
                  <select class="form-select" id="addUserStatus">
                    <option value="active" selected>Active</option>
                    <option value="inactive">Inactive</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label for="addUserPassword" class="form-label">Password</label>
                  <input type="password" class="form-control" id="addUserPassword" required placeholder="Enter initial password">
                </div>
                <div id="addUserError" class="text-danger small"></div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary">Add</button>
              </div>
            </form>
          </div>
        </div>
      </div>
      <!-- Edit Modal -->
      <div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="editUserModalLabel">Edit User</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editUserForm">
              <div class="modal-body">
                <input type="hidden" id="editUserId">

                <div class="mb-3">
                  <label for="editUserSchoolId" class="form-label">School ID</label>
                  <input type="text" class="form-control" id="editUserSchoolId" required>
                </div>

                <div class="mb-3">
                  <label for="editUserName" class="form-label">Name (Lastname, Firstname M.I.)</label>
                  <input type="text" class="form-control" id="editUserName" required placeholder="Lastname, Firstname M.I.">
                </div>
                <div class="mb-3">
                  <label for="editUserEmail" class="form-label">Email</label>
                  <input type="email" class="form-control" id="editUserEmail" required>
                </div>
                <div class="mb-3">
                    <label for="editUserRole" class="form-label">Role</label>
                    <select class="form-select" id="editUserRole">
                        <option value="">Select role</option>
                        <option value="Non-Teaching">Non-Teaching</option>
                        <option value="Teacher">Teacher</option>
                        <option value="Student">Student</option>
                    </select>
                </div>
                <script>
                    // Set selected role when opening edit modal
                    window.openEdit = function(id) {
                        const user = users.find(u => u.id == id);
                        if (!user) return;
                        document.getElementById('editUserId').value = user.id;
                        document.getElementById('editUserSchoolId').value = user.student_faculty_id;
                        document.getElementById('editUserName').value = `${user.last_name}, ${user.first_name}${user.middle_initial ? ' ' + user.middle_initial + '.' : ''}`;
                        document.getElementById('editUserEmail').value = user.email;
                        document.getElementById('editUserRole').value = user.role ? user.role : 'user';
                        const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
                        modal.show();
                    }
                </script>
              </div>
              <div class="modal-footer">
                <button type="submit" class="btn btn-primary">Save Changes</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </main>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let users = [];
    let hasStatus = false;
    let listSource = 'users'; // 'users' | 'doc_nurse' | 'admins'
    let currentPage = 1;
    const rowsPerPage = 10;
    function renderUsers(filter = '') {
      const tbody = document.querySelector('#usersTable tbody');
      tbody.innerHTML = '';
      const roleVal = document.getElementById('roleFilter').value;
      const statusVal = document.getElementById('statusFilter').value;
      const filtered = users.filter(u => {
        const baseName = (u.last_name && u.first_name !== undefined)
          ? `${u.last_name}, ${u.first_name}${u.middle_initial ? ' ' + u.middle_initial + '.' : ''}`
          : (u.name || '');
        const fullName = baseName;
        const sid = (u.student_faculty_id || u.school_id || '');
        const passText = fullName.toLowerCase().includes(filter)
          || (u.email && u.email.toLowerCase().includes(filter))
          || (sid && String(sid).toLowerCase().includes(filter));
        const passRole = (roleVal === 'All') || ((String(u.role||'').trim()).toLowerCase() === (roleVal||'').toLowerCase());
        const statusNorm = (() => { const s=(statusVal||'').trim().toLowerCase(); return s==='archived' ? 'inactive' : s; })();
        const passStatus = (statusNorm === 'all') || ((u.status !== undefined) ? ((String(u.status||'active')).toLowerCase() === statusNorm) : true);
        return passText && passRole && passStatus;
      });
      const totalRows = filtered.length;
      const totalPages = Math.ceil(totalRows / rowsPerPage) || 1;
      if (currentPage > totalPages) currentPage = totalPages;
      const startIdx = (currentPage - 1) * rowsPerPage;
      const endIdx = startIdx + rowsPerPage;
      filtered.slice(startIdx, endIdx).forEach(user => {
        const fullName = (user.last_name && user.first_name !== undefined)
          ? `${user.last_name}, ${user.first_name}${user.middle_initial ? ' ' + user.middle_initial + '.' : ''}`
          : (user.name || '');
        const tr = document.createElement('tr');
        const status = (user.status || 'active');
        const statusLower = String(status).toLowerCase();
        const statusText = statusLower === 'inactive' ? 'Archived' : 'Active';
        const statusHtml = (user.status !== undefined)
          ? `<span class="badge ${statusLower==='active'?'bg-success':'bg-secondary'}" id="status-${user.id}">${statusText}</span>`
          : `<span class="text-muted">N/A</span>`;
        let actionsHtml = '';
        const rowSource = user._source || listSource;
        if (rowSource === 'users') {
          const toggleNext = status==='active' ? 'inactive' : 'active';
          const toggleText = status==='active' ? 'Deactivate' : 'Activate';
          const toggleClass = status==='active' ? 'btn btn-xs btn-outline-danger' : 'btn btn-xs btn-success';
          actionsHtml = `
            <button class='btn btn-xs btn-primary' style='padding:2px 8px;font-size:0.85rem;' onclick='openEdit(${user.id})'>Edit</button>
            <button class='${toggleClass}' style='padding:2px 8px;font-size:0.85rem;' onclick='toggleStatus(${user.id}, "${toggleNext}")'>${toggleText}</button>
            <button class='btn btn-xs btn-outline-primary' style='padding:2px 8px;font-size:0.85rem;' onclick='resetPassword(${user.id})'>Reset Password</button>
            <button class='btn btn-xs btn-danger' style='padding:2px 8px;font-size:0.85rem;' onclick='deleteUser(${user.id})'>Delete</button>
          `;
        } else if (rowSource === 'doc_nurse') {
          const toggleNext = status==='active' ? 'inactive' : 'active';
          const toggleText = status==='active' ? 'Deactivate' : 'Activate';
          const toggleClass = status==='active' ? 'btn btn-xs btn-outline-danger' : 'btn btn-xs btn-success';
          actionsHtml = `
            <button class='${toggleClass}' style='padding:2px 8px;font-size:0.85rem;' onclick='toggleStatusDocNurse(${user.id}, "${toggleNext}")'>${toggleText}</button>
            <button class='btn btn-xs btn-outline-primary' style='padding:2px 8px;font-size:0.85rem;' onclick='resetPasswordDocNurse(${user.id})'>Reset Password</button>
            <button class='btn btn-xs btn-danger' style='padding:2px 8px;font-size:0.85rem;' onclick='deleteDocNurse(${user.id})'>Delete</button>
          `;
        } else if (rowSource === 'admins') {
          const toggleNext = status==='active' ? 'inactive' : 'active';
          const toggleText = status==='active' ? 'Deactivate' : 'Activate';
          const toggleClass = status==='active' ? 'btn btn-xs btn-outline-danger' : 'btn btn-xs btn-success';
          actionsHtml = `
            <button class='${toggleClass}' style='padding:2px 8px;font-size:0.85rem;' onclick='toggleStatusAdmin(${user.id}, "${toggleNext}")'>${toggleText}</button>
            <button class='btn btn-xs btn-outline-primary' style='padding:2px 8px;font-size:0.85rem;' onclick='resetPasswordAdmin(${user.id})'>Reset Password</button>
            <button class='btn btn-xs btn-danger' style='padding:2px 8px;font-size:0.85rem;' onclick='deleteAdmin(${user.id})'>Delete</button>
          `;
        } else {
          actionsHtml = `<span class="text-muted">Actions not available</span>`;
        }
        const sid = user.student_faculty_id || user.school_id || '';
        tr.innerHTML = `<td>${sid}</td><td>${fullName}</td><td>${user.email || ''}</td><td>${user.role || ''}</td>
          <td>${statusHtml}</td>
          <td style="white-space:nowrap;">${actionsHtml}</td>`;
        tbody.appendChild(tr);
      });
      // Pagination controls (patient.html style)
      const pagWrap = document.getElementById('usersPaginationContainer');
      const prevBtn = document.getElementById('usersPrev');
      const nextBtn = document.getElementById('usersNext');
      const pageInfo = document.getElementById('usersPageInfo');
      if (pagWrap) {
        if (totalRows <= rowsPerPage) {
          pagWrap.style.display = 'none';
        } else {
          pagWrap.style.display = 'flex';
          if (pageInfo) pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
          if (prevBtn) {
            const disabled = currentPage <= 1;
            prevBtn.disabled = disabled;
            prevBtn.setAttribute('aria-disabled', disabled ? 'true' : 'false');
            prevBtn.style.background = disabled ? '#9ca3af' : '#2563eb';
            prevBtn.style.cursor = disabled ? 'not-allowed' : 'pointer';
            prevBtn.style.opacity = disabled ? '0.6' : '1';
            prevBtn.onclick = function(e) {
              e.preventDefault();
              if (!disabled) {
                currentPage--;
                renderUsers(filter);
              }
            };
          }
          if (nextBtn) {
            const disabled = currentPage >= totalPages;
            nextBtn.disabled = disabled;
            nextBtn.setAttribute('aria-disabled', disabled ? 'true' : 'false');
            nextBtn.style.background = disabled ? '#9ca3af' : '#2563eb';
            nextBtn.style.cursor = disabled ? 'not-allowed' : 'pointer';
            nextBtn.style.opacity = disabled ? '0.6' : '1';
            nextBtn.onclick = function(e) {
              e.preventDefault();
              if (!disabled) {
                currentPage++;
                renderUsers(filter);
              }
            };
          }
        }
      }
    }
    function fetchUsers() {
      const q = document.getElementById('searchUser').value.trim();
      const role = document.getElementById('roleFilter').value;
      const status = document.getElementById('statusFilter').value;
      // Choose source based on role
      const dnRoles = ['Doctor','Dentist','Nurse'];
      if (role === 'Admin') {
        listSource = 'admins';
        const params = new URLSearchParams({ q });
        fetch('../../backend/api/manage_user.php?action=list_admins&' + params.toString())
          .then(res => res.json())
          .then(data => {
            if (data.success && data.users) {
              users = data.users;
              hasStatus = false;
              renderUsers(document.getElementById('searchUser').value.toLowerCase());
            }
          });
      } else if (dnRoles.includes(role)) {
        listSource = 'doc_nurse';
        const params = new URLSearchParams({ q, role });
        fetch('../../backend/api/manage_user.php?action=list_doc_nurse&' + params.toString())
          .then(res => res.json())
          .then(data => {
            if (data.success && data.users) {
              users = data.users;
              hasStatus = false;
              renderUsers(document.getElementById('searchUser').value.toLowerCase());
            }
          });
      } else if (['Student','Teacher','Non-Teaching'].includes(role)) {
        listSource = 'users';
        const params = new URLSearchParams({ q, role, status });
        fetch('../../backend/api/manage_user.php?action=list&' + params.toString())
          .then(res => res.json())
          .then(data => {
            if (data.success && data.users) {
              users = data.users;
              hasStatus = !!data.hasStatus;
              renderUsers(document.getElementById('searchUser').value.toLowerCase());
            }
          });
      } else if (role === 'All') {
        // Aggregate: users + doc_nurse + admins
        listSource = 'all';
        const pUsers = (() => {
          const params = new URLSearchParams({ q, role: 'All', status });
          return fetch('../../backend/api/manage_user.php?action=list&' + params.toString())
            .then(r => r.json())
            .then(d => d.success ? d : {success:true, users:[], hasStatus:false});
        })();
        const pDN = (() => {
          const params = new URLSearchParams({ q });
          return fetch('../../backend/api/manage_user.php?action=list_doc_nurse&' + params.toString())
            .then(r => r.json())
            .then(d => d.success ? d : {success:true, users:[], hasStatus:false});
        })();
        const pAdmins = (() => {
          const params = new URLSearchParams({ q });
          return fetch('../../backend/api/manage_user.php?action=list_admins&' + params.toString())
            .then(r => r.json())
            .then(d => d.success ? d : {success:true, users:[], hasStatus:false});
        })();
        Promise.all([pUsers, pDN, pAdmins]).then(([u, dn, ad]) => {
          // Merge with source tags so actions can be per-row
          const uTagged = (u.users||[]).map(x => ({...x, _source: 'users'}));
          const dnTagged = (dn.users||[]).map(x => ({...x, _source: 'doc_nurse'}));
          const adTagged = (ad.users||[]).map(x => ({...x, _source: 'admins'}));
          const merged = [...uTagged, ...dnTagged, ...adTagged];
          users = merged;
          hasStatus = true; // per-entry logic will handle display; this just keeps the Status column intent
          renderUsers(document.getElementById('searchUser').value.toLowerCase());
        });
      } else {
        listSource = 'users';
        const params = new URLSearchParams({ q, role, status });
        fetch('../../backend/api/manage_user.php?action=list&' + params.toString())
          .then(res => res.json())
          .then(data => {
            if (data.success && data.users) {
              users = data.users;
              hasStatus = !!data.hasStatus;
              renderUsers(document.getElementById('searchUser').value.toLowerCase());
            }
          });
      }
    }
    document.getElementById('searchUser').addEventListener('input', function() {
      renderUsers(this.value.toLowerCase());
    });
    document.getElementById('roleFilter').addEventListener('change', fetchUsers);
    document.getElementById('statusFilter').addEventListener('change', fetchUsers);
    document.getElementById('refreshBtn').addEventListener('click', fetchUsers);
    fetchUsers();
    window.openEdit = function(id) {
      const user = users.find(u => u.id == id);
      if (!user) return;
      document.getElementById('editUserId').value = user.id;
      document.getElementById('editUserSchoolId').value = user.student_faculty_id;
      document.getElementById('editUserName').value = `${user.last_name}, ${user.first_name}${user.middle_initial ? ' ' + user.middle_initial + '.' : ''}`;
      document.getElementById('editUserEmail').value = user.email;
      document.getElementById('editUserRole').value = user.role ? user.role : 'user';
      const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
      modal.show();
    }
    document.getElementById('editUserForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const id = document.getElementById('editUserId').value;
      const schoolId = document.getElementById('editUserSchoolId').value;
      const name = document.getElementById('editUserName').value;
      const email = document.getElementById('editUserEmail').value;
      const role = document.getElementById('editUserRole').value;
      // Split name into last_name, first_name, middle_initial
      let last_name = '', first_name = '', middle_initial = '';
      const nameParts = name.split(',');
      if (nameParts.length >= 2) {
        last_name = nameParts[0].trim();
        let firstAndMI = nameParts[1].trim().split(' ');
        first_name = firstAndMI[0] || '';
        if (firstAndMI.length > 1) {
          middle_initial = firstAndMI[1].replace('.', '').trim();
        }
      } else {
        last_name = name.trim();
      }
      fetch('../../backend/api/manage_user.php?action=update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `id=${id}&student_faculty_id=${encodeURIComponent(schoolId)}&last_name=${encodeURIComponent(last_name)}&first_name=${encodeURIComponent(first_name)}&middle_initial=${encodeURIComponent(middle_initial)}&email=${encodeURIComponent(email)}&role=${role}`
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          fetchUsers();
          bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
        }
      });
    });
    // Add User submit
    const addUserForm = document.getElementById('addUserForm');
    if (addUserForm) {
      addUserForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const entityType = document.getElementById('addEntityType').value;
        const schoolId = document.getElementById('addUserSchoolId').value.trim();
        const lastName = document.getElementById('addUserLastName').value.trim();
        const firstName = document.getElementById('addUserFirstName').value.trim();
        const middleInitial = document.getElementById('addUserMiddleInitial').value.trim();
        const email = document.getElementById('addUserEmail').value.trim();
          const role = document.getElementById('addUserRole').value;
          const gender = document.getElementById('addUserGender').value.trim();
          const dob = document.getElementById('addUserDob').value.trim();
          const yearCourse = document.getElementById('addUserYearCourse').value.trim();
          const department = document.getElementById('addUserDepartment').value.trim();
        const status = document.getElementById('addUserStatus').value;
        const password = document.getElementById('addUserPassword').value.trim();
        const err = document.getElementById('addUserError');
        err.textContent = '';
  if (entityType === 'admin' || role === 'Admin') {
          // Admin creation
          if (!lastName || !firstName || !email || !password) {
            err.textContent = 'Please fill out name, email, and password for admin.'; return;
          }
          const body = new URLSearchParams();
          body.set('action','add_admin');
          // Compose name "Last, First M." on backend too, but send parts for fallback
          body.set('last_name', lastName);
          body.set('first_name', firstName);
          body.set('middle_initial', middleInitial);
          body.set('email', email);
          body.set('status', status);
          if (schoolId) body.set('school_id', schoolId);
          if (password) body.set('password', password);
          fetch('../../backend/api/manage_user.php', {
            method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: body.toString()
          }).then(r=>r.json()).then(d=>{
            if (d.success) {
              fetchUsers();
              const modal = bootstrap.Modal.getInstance(document.getElementById('addUserModal')) || new bootstrap.Modal(document.getElementById('addUserModal'));
              modal.hide();
              addUserForm.reset();
            } else {
              err.textContent = d.message || 'Failed to add admin.';
            }
          }).catch(()=>{ err.textContent = 'Network error.'; });
        } else {
          // Regular user creation
          if (!schoolId || !lastName || !firstName || !email || !role || !password) {
            err.textContent = 'Please fill out all required fields including password.';
            return;
          }
          // Validate DOB if provided
          if (dob) {
            const dobDate = new Date(dob + 'T00:00:00');
            const today = new Date();
            if (dobDate.getTime() > today.getTime()) { err.textContent = 'Birthdate cannot be in the future.'; return; }
          }
          // Map UI combined role label to supported backend role
          let roleToSend = role;
          if (role === 'Student/Faculty/Staff') { roleToSend = 'Student'; }
          const body = new URLSearchParams();
          body.set('action','add');
          body.set('student_faculty_id', schoolId);
          body.set('last_name', lastName);
          body.set('first_name', firstName);
          body.set('middle_initial', middleInitial);
          body.set('email', email);
          body.set('client', roleToSend); // new alias used by auth.php
          if (gender) body.set('gender', gender);
          if (dob) body.set('date_of_birth', dob);
          if (yearCourse && roleToSend === 'Student') body.set('year_course', yearCourse);
          if (department && (roleToSend === 'Teacher' || roleToSend === 'Non-Teaching')) body.set('department', department);
          body.set('status', status);
          if (password) body.set('password', password);
          fetch('../../backend/api/manage_user.php', {
            method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: body.toString()
          }).then(res => res.json()).then(data => {
            if (data.success) {
              fetchUsers();
              const modal = bootstrap.Modal.getInstance(document.getElementById('addUserModal')) || new bootstrap.Modal(document.getElementById('addUserModal'));
              modal.hide();
              addUserForm.reset();
            } else {
              err.textContent = data.message || 'Failed to add user.';
            }
          }).catch(() => { err.textContent = 'Network error.'; });
        }
      });
    }
    // Toggle fields for admin vs user
    const addEntityType = document.getElementById('addEntityType');
    if (addEntityType) {
      const adminHint = document.getElementById('adminHint');
      const schoolIdGroup = document.getElementById('addUserSchoolId').closest('.mb-3');
      const roleGroup = document.getElementById('addUserRole').closest('.mb-3');
      const roleSelect = document.getElementById('addUserRole');
      function fillRoleOptionsFor(type){
        // Clear
        while (roleSelect.firstChild) roleSelect.removeChild(roleSelect.firstChild);
        const frag = document.createDocumentFragment();
        const addOpt = (val, label) => { const o = document.createElement('option'); o.value = val; o.textContent = label; frag.appendChild(o); };
        if (type === 'admin') {
          // Keep hidden, no options
        } else {
          // Type=user â†’ only Dentist and Student/Faculty/Staff
          addOpt('', 'Select role');
          addOpt('Dentist', 'Dentist');
          addOpt('Student/Faculty/Staff', 'Student/Faculty/Staff');
        }
        roleSelect.appendChild(frag);
      }
      // Role-dependent visibility logic
      function applyClientVisibility(){
        const val = roleSelect.value;
        const genderGroup = document.getElementById('addUserGenderGroup');
        const dobGroup = document.getElementById('addUserDobGroup');
        const yearCourseGroup = document.getElementById('addUserYearCourseGroup');
        const deptGroup = document.getElementById('addUserDepartmentGroup');
        const yearCourseEl = document.getElementById('addUserYearCourse');
        const deptEl = document.getElementById('addUserDepartment');
        // Always show gender + DOB for user accounts
        const isAdminType = addEntityType.value === 'admin';
        genderGroup.style.display = isAdminType ? 'none' : 'block';
        dobGroup.style.display = isAdminType ? 'none' : 'block';
        if (isAdminType) {
          yearCourseGroup.style.display = 'none'; deptGroup.style.display = 'none'; yearCourseEl.value=''; deptEl.value='';
          return;
        }
        // Map combined label to internal Student
        const normalized = (val === 'Student/Faculty/Staff') ? 'Student' : val;
        if (normalized === 'Student') {
          yearCourseGroup.style.display = 'block'; deptGroup.style.display = 'none'; deptEl.value='';
        } else if (normalized === 'Dentist') {
          yearCourseGroup.style.display = 'none'; yearCourseEl.value=''; deptGroup.style.display = 'none'; deptEl.value='';
        } else {
          yearCourseGroup.style.display = 'none'; yearCourseEl.value=''; deptGroup.style.display = 'none'; deptEl.value='';
        }
      }
      roleSelect.addEventListener('change', applyClientVisibility);
      document.getElementById('addEntityType').addEventListener('change', applyClientVisibility);
      // DOB age preview
      const dobEl = document.getElementById('addUserDob');
      const agePreview = document.getElementById('addUserAgePreview');
      function computeAge(d){ if(!d) return ''; const today=new Date(); const dob=new Date(d+'T00:00:00'); if(isNaN(dob.getTime())) return ''; let age=today.getFullYear()-dob.getFullYear(); const m=today.getMonth()-dob.getMonth(); if(m<0||(m===0&&today.getDate()<dob.getDate())) age--; return (age<0||age>150)?'':String(age); }
      if (dobEl) {
        dobEl.addEventListener('change', () => { const a=computeAge(dobEl.value); if(a){ agePreview.textContent='Age: '+a; agePreview.style.display='block'; } else { agePreview.textContent=''; agePreview.style.display='none'; } });
        // set max to today
        dobEl.max = new Date().toISOString().slice(0,10);
      }
      // Initialize visibility
      applyClientVisibility();
      addEntityType.addEventListener('change', function(){
        const isAdmin = this.value === 'admin';
        if (schoolIdGroup) schoolIdGroup.style.display = isAdmin ? 'none' : '';
        if (roleGroup) roleGroup.style.display = isAdmin ? 'none' : '';
        if (adminHint) adminHint.style.display = isAdmin ? 'block' : 'none';
        // If admin selected, ensure role select is not accidentally set
        fillRoleOptionsFor(this.value);
        if (isAdmin) { document.getElementById('addUserRole').value = ''; }
      });
      // Initial fill
      fillRoleOptionsFor(addEntityType.value || 'user');
    }
    window.deleteUser = function(id) {
      if (!confirm('Are you sure you want to delete this user?')) return;
      fetch('../../backend/api/manage_user.php?action=delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `id=${id}`
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) fetchUsers();
      });
    }

    window.toggleStatus = function(id, status) {
      // Confirm before toggling
      const u = users.find(x => x.id == id);
      const fullName = u ? ((u.last_name && u.first_name !== undefined)
        ? `${u.last_name}, ${u.first_name}${u.middle_initial ? ' ' + u.middle_initial + '.' : ''}`
        : (u.name || 'this user')) : 'this user';
      if (status === 'inactive') {
        const sid = (u && u.student_faculty_id) ? ` (ID: ${u.student_faculty_id})` : '';
        if (!confirm(`Deactivate ${fullName}${sid}? They will not be able to log in until re-activated.`)) return;
      } else if (status === 'active') {
        if (!confirm(`Activate ${fullName}?`)) return;
      }
      fetch('../../backend/api/manage_user.php?action=toggle_status', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `id=${id}&status=${encodeURIComponent(status)}`
      }).then(res=>res.json()).then(data=>{
        if (data.success) fetchUsers();
      });
    }

    window.resetPassword = function(id) {
      if (!confirm('Reset password for this user? A random password will be generated.')) return;
      fetch('../../backend/api/manage_user.php?action=reset_password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `id=${id}`
      }).then(res=>res.json()).then(data=>{
        if (data.success) {
          const pwd = data.new_password;
          alert(pwd ? `New password: ${pwd}` : 'Password has been reset.');
        }
      });
    }
    // Doc/Nurse actions
    window.toggleStatusDocNurse = function(id, status) {
      if (status === 'inactive') {
        if (!confirm('Deactivate this staff account?')) return;
      } else if (status === 'active') {
        if (!confirm('Activate this staff account?')) return;
      }
      fetch('../../backend/api/manage_user.php?action=toggle_status_doc_nurse', {
        method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: `id=${id}&status=${encodeURIComponent(status)}`
      }).then(r=>r.json()).then(d=>{ if (d.success) fetchUsers(); });
    }
    window.resetPasswordDocNurse = function(id) {
      if (!confirm('Reset password for this staff?')) return;
      fetch('../../backend/api/manage_user.php?action=reset_password_doc_nurse', {
        method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: `id=${id}`
      }).then(r=>r.json()).then(d=>{ if (d.success) alert(d.new_password ? `New password: ${d.new_password}` : 'Password reset.'); });
    }
    window.deleteDocNurse = function(id) {
      if (!confirm('Delete this staff account? This action cannot be undone.')) return;
      fetch('../../backend/api/manage_user.php?action=delete_doc_nurse', {
        method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: `id=${id}`
      }).then(r=>r.json()).then(d=>{ if (d.success) fetchUsers(); });
    }
    // Admin actions
    window.toggleStatusAdmin = function(id, status) {
      if (status === 'inactive') {
        if (!confirm('Deactivate this admin account?')) return;
      } else if (status === 'active') {
        if (!confirm('Activate this admin account?')) return;
      }
      fetch('../../backend/api/manage_user.php?action=toggle_status_admin', {
        method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: `id=${id}&status=${encodeURIComponent(status)}`
      }).then(r=>r.json()).then(d=>{ if (d.success) fetchUsers(); });
    }
    window.resetPasswordAdmin = function(id) {
      if (!confirm('Reset password for this admin?')) return;
      fetch('../../backend/api/manage_user.php?action=reset_password_admin', {
        method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: `id=${id}`
      }).then(r=>r.json()).then(d=>{ if (d.success) alert(d.new_password ? `New password: ${d.new_password}` : 'Password reset.'); });
    }
    window.deleteAdmin = function(id) {
      if (!confirm('Delete this admin account? This action cannot be undone.')) return;
      fetch('../../backend/api/manage_user.php?action=delete_admin', {
        method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: `id=${id}`
      }).then(r=>r.json()).then(d=>{ if (d.success) fetchUsers(); });
    }
  </script>
  <script src="../assets/js/dashboard_interactive.js"></script>
</body>
</html>
