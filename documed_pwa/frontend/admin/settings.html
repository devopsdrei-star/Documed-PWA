<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DocuMed</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/style.css?v=docnurse2">
  <link rel="stylesheet" href="../assets/css/docnurse_layout.css?v=1">
  <link rel="icon" type="image/png" href="../assets/images/documed_logo.png" />
  <style>
    body { background: #f3f4f6; color: #111; }
    .main-content { background: #fff; box-shadow: 0 8px 32px rgba(37,99,235,0.14); }
    h1 { color: #111; font-size: 2rem; margin-bottom: 24px; text-align: center; letter-spacing: 1px; font-weight: 700; text-shadow: 0 2px 8px rgba(37,99,235,0.08); }
    .card { box-shadow: 0 2px 12px rgba(2,6,23,0.06); }
  </style>
</head>
<body>
  <div class="admin-layout" style="box-shadow: 0 8px 32px rgba(37,99,235,0.18); border-radius: 18px; width: 100vw; min-height: 100vh; margin: 0; max-width: none;">
    <aside class="sidebar">
  <div class="logo"><img src="../assets/images/documed_logo.png" alt="DocuMed" /></div>
      <nav class="sidebar-nav">
  <a href="dashboard.html" class="sidebar-link"><i class="bi bi-speedometer2 me-2"></i>Dashboard</a>
  <a href="patients.html" class="sidebar-link"><i class="bi bi-people me-2"></i>Patients</a>
  <a href="appointments.html" class="sidebar-link"><i class="bi bi-calendar-check me-2"></i>Appointments</a>
  <a href="manage_users.html" class="sidebar-link"><i class="bi bi-person-gear me-2"></i>Manage user</a>
  <a href="audit_trail.html" class="sidebar-link"><i class="bi bi-clock-history me-2"></i>Activity log</a> 
  <a href="medicine_inventory.html" class="sidebar-link"><i class="bi bi-capsule me-2"></i>Medicine</a>
  <a href="reports.html" class="sidebar-link"><i class="bi bi-graph-up me-2"></i>Reports</a>
  <a href="settings.html" class="sidebar-link active"><i class="bi bi-gear me-2"></i>Settings</a>
      </nav>
    </aside>
    <main class="main-content p-4">
      <h1>Admin Settings</h1>
      <div class="row g-3">
        <div class="col-12 col-lg-6">
          <div class="card p-3">
            <h5>General Settings</h5>
            <div class="mb-2">
              <label class="form-label">Clinic Name</label>
              <input type="text" class="form-control" id="clinicName" placeholder="DocuMed Clinic">
            </div>
            <div class="mb-2">
              <label class="form-label">Banner Message</label>
              <input type="text" class="form-control" id="bannerMessage" placeholder="Welcome to DocuMed">
            </div>
            <div class="mb-2">
              <label class="form-label">Operating Hours (e.g., Mon-Fri 08:00-17:00)</label>
              <input type="text" class="form-control" id="operatingHours" placeholder="Mon-Fri 08:00-17:00">
            </div>
            <div class="mb-2">
              <label class="form-label">Max Appointments per Day</label>
              <input type="number" class="form-control" id="maxDailySlots" min="0" step="1" placeholder="e.g., 50">
            </div>
            <div class="mb-3">
              <label class="form-label">Notification Template (Appointment Approved)</label>
              <textarea class="form-control" id="notifApproved" rows="2" placeholder="Your appointment on {{date}} at {{time}} has been approved."></textarea>
            </div>
            <button id="saveSettings" class="btn btn-primary">Save Settings</button>
          </div>
        </div>
        <div class="col-12 col-lg-6">
          <div class="card p-3">
            <h5>Announcements</h5>
            <div class="mb-2">
              <label class="form-label">Audience</label>
              <select class="form-select" id="announceAudience">
                <option>All</option>
                <option>Student</option>
                <option>Faculty</option>
                <option>Staff</option>
              </select>
            </div>
            <div class="mb-2">
              <label class="form-label">Message</label>
              <textarea class="form-control" id="announceMessage" rows="3" placeholder="Type announcement..."></textarea>
            </div>
            <div class="mb-2">
              <label class="form-label">Expires (optional)</label>
              <input type="date" class="form-control" id="announceExpires">
            </div>
            <button id="postAnnouncement" class="btn btn-primary">Post Announcement</button>
            <hr>
            <div id="announcementsList" class="small text-muted"></div>
          </div>
        </div>
        <div class="col-12">
          <div class="card p-3">
            <h5>Data Export</h5>
            <div class="d-flex gap-2 flex-wrap">
              <a class="btn btn-outline-secondary" href="../../backend/api/admin_tools.php?action=export_csv&type=users">Export Users CSV</a>
              <a class="btn btn-outline-secondary" href="../../backend/api/admin_tools.php?action=export_csv&type=patients">Export Patients CSV</a>
              <a class="btn btn-outline-secondary" href="../../backend/api/admin_tools.php?action=export_csv&type=appointments">Export Appointments CSV</a>
              <a class="btn btn-outline-secondary" href="../../backend/api/admin_tools.php?action=export_csv&type=checkups">Export Checkups CSV</a>
              <a class="btn btn-outline-primary" href="../../backend/api/admin_tools.php?action=export_json&type=all">Download JSON Backup (All)</a>
              <a class="btn btn-outline-primary" href="../../backend/api/admin_tools.php?action=export_json&type=appointments">Download JSON (Appointments)</a>
            </div>
            <hr>
            <h6>Import (Settings & Announcements Only)</h6>
            <div class="d-flex gap-2 align-items-center flex-wrap">
              <input type="file" id="importJsonFile" accept="application/json" class="form-control" style="max-width:360px;">
              <button id="importJsonBtn" class="btn btn-warning">Import JSON</button>
              <small class="text-muted">Safeguarded: only updates settings and announcements.</small>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
  <script>
    // Load settings
    fetch('../../backend/api/admin_tools.php?action=settings_get').then(r=>r.json()).then(d=>{
      if (d.settings) {
        document.getElementById('clinicName').value = d.settings.clinic_name || '';
        document.getElementById('bannerMessage').value = d.settings.banner_message || '';
        document.getElementById('operatingHours').value = d.settings.operating_hours || '';
        document.getElementById('maxDailySlots').value = d.settings.max_daily_slots || '';
        document.getElementById('notifApproved').value = d.settings.notif_approved || '';
      }
    });
    // Save settings
    document.getElementById('saveSettings').onclick = ()=>{
      const pairs = [
        ['clinic_name', document.getElementById('clinicName').value.trim()],
        ['banner_message', document.getElementById('bannerMessage').value.trim()],
        ['operating_hours', document.getElementById('operatingHours').value.trim()],
        ['max_daily_slots', document.getElementById('maxDailySlots').value.trim()],
        ['notif_approved', document.getElementById('notifApproved').value.trim()]
      ];
      Promise.all(pairs.map(([k,v])=>fetch('../../backend/api/admin_tools.php?action=settings_set',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:`key=${encodeURIComponent(k)}&value=${encodeURIComponent(v)}`})))
        .then(()=>alert('Settings saved'));
    };
    // Post announcement
    document.getElementById('postAnnouncement').onclick = ()=>{
      const audience = document.getElementById('announceAudience').value;
      const message = document.getElementById('announceMessage').value.trim();
      const expires = document.getElementById('announceExpires').value;
      if (!message) return alert('Message required');
      const body = new URLSearchParams();
      body.set('audience', audience);
      body.set('message', message);
      if (expires) body.set('expires_at', expires);
      fetch('../../backend/api/admin_tools.php?action=announcements_post',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body: body.toString()})
        .then(r=>r.json()).then(d=>{ if (d.success) { document.getElementById('announceMessage').value=''; document.getElementById('announceExpires').value=''; loadAnnouncements(); }});
    };
    function loadAnnouncements(){
      fetch('../../backend/api/admin_tools.php?action=announcements_list&limit=10').then(r=>r.json()).then(d=>{
        if (d.announcements) {
          document.getElementById('announcementsList').innerHTML = d.announcements.map(a=>`<div>[${a.created_at}] (${a.audience}) ${a.message}${a.expires_at?` <span class="badge bg-secondary">until ${a.expires_at}</span>`:''}</div>`).join('');
        }
      });
    }
    loadAnnouncements();

    // Import JSON (safe: settings & announcements only)
    document.getElementById('importJsonBtn').onclick = async ()=>{
      const f = document.getElementById('importJsonFile').files[0];
      if (!f) return alert('Select a JSON file first');
      const text = await f.text();
      try {
        const json = JSON.parse(text);
        const data = json.data || json;
  const settings = data.settings || data.data?.settings || null;
        const announcements = data.announcements || data.data?.announcements || null;
        const tasks = [];
        if (settings) {
          if (Array.isArray(settings)) {
            settings.forEach(row=>{
              const k = row.key || row['key'];
              const v = row.value || row['value'] || '';
              if (k) tasks.push(fetch('../../backend/api/admin_tools.php?action=settings_set',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:`key=${encodeURIComponent(k)}&value=${encodeURIComponent(String(v))}`}));
            });
          } else if (typeof settings === 'object') {
            Object.entries(settings).forEach(([k,v])=>{
              tasks.push(fetch('../../backend/api/admin_tools.php?action=settings_set',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:`key=${encodeURIComponent(k)}&value=${encodeURIComponent(String(v))}`}));
            });
          }
        }
        if (Array.isArray(announcements)) {
          announcements.forEach(a=>{
            const msg = (a.message || '').toString();
            const aud = (a.audience || 'All').toString();
            const exp = (a.expires_at || '').toString();
            if (msg) {
              const body = new URLSearchParams();
              body.set('audience', aud);
              body.set('message', msg);
              if (exp) body.set('expires_at', exp);
              tasks.push(fetch('../../backend/api/admin_tools.php?action=announcements_post',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body: body.toString()}));
            }
          });
        }
        if (tasks.length === 0) return alert('No importable content found (settings/announcements).');
        await Promise.all(tasks);
        alert('Import completed');
        loadAnnouncements();
      } catch (e) {
        alert('Invalid JSON file');
      }
    };
  </script>
  <script src="../assets/js/dashboard_interactive.js"></script>
</body>
</html>
