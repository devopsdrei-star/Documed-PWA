<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DocuMed</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="icon" type="image/png" href="../assets/images/documed_logo.png" />
  <style>
    body { background:#f8fafc; }
    .container-narrow { max-width: 980px; }
  </style>
</head>
<body>
  <div class="container container-narrow py-4">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h3 class="m-0">Archived Bookings</h3>
      <button id="backBtn" class="btn btn-outline-secondary">Back to Appointments</button>
    </div>
    <div class="row g-2 align-items-center mb-3">
      <div class="col-sm-8">
        <input type="text" id="search" class="form-control" placeholder="Search name/date/purpose/status">
      </div>
      <div class="col-sm-4">
        <select id="status" class="form-select">
          <option value="all">All archived statuses</option>
          <option value="declined">Declined</option>
          <option value="completed">Completed</option>
          <option value="cancelled">Cancelled</option>
        </select>
      </div>
    </div>
    <div class="table-responsive">
      <table class="table table-sm table-striped align-middle" id="archTable">
        <thead class="table-light">
          <tr>
            <th>Date</th><th>Time</th><th>Name</th><th>Purpose</th><th>Status</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div id="msg" class="text-muted"></div>
  </div>

  <script>
  (function(){
    const backBtn = document.getElementById('backBtn');
    const search = document.getElementById('search');
    const statusSel = document.getElementById('status');
    const tbody = document.querySelector('#archTable tbody');
    const msg = document.getElementById('msg');
    function setMsg(t){ msg.textContent = t || ''; }

    // Route back to the correct appointments page for the role
    backBtn.addEventListener('click', ()=>{
      const base = window.location.pathname.split('/frontend/')[0];
      window.location.href = base + '/frontend/doc_nurse/appointments.html';
    });

    function fmt12(t){ if(!t) return ''; const p=t.split(':'); let h=parseInt(p[0]||'0',10); const mm=(p[1]||'00'); const am = h<12; if(h===0)h=12; if(h>12)h-=12; return `${h}:${mm} ${am?'AM':'PM'}`; }

    let allRows = [];
    function apply(){
      let rows = allRows.slice();
      const q = (search.value||'').toLowerCase().trim();
      const st = statusSel.value;
      if (st && st!=='all') rows = rows.filter(r => (r.status||'').toLowerCase()===st);
      if (q) rows = rows.filter(r => {
        const s = [r.name||'', r.date||'', r.purpose||'', r.status||''].join(' ').toLowerCase();
        return s.includes(q);
      });
      tbody.innerHTML = '';
      if (rows.length===0){ setMsg('No archived bookings found.'); return; }
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        const raw = r.time && r.time.length>5 ? r.time.slice(0,5) : (r.time||'');
        tr.innerHTML = `<td>${r.date||''}</td><td>${fmt12(raw)}</td><td>${r.name||r.patient_name||''}</td><td>${r.purpose||r.service||''}</td><td style="text-transform:capitalize;">${(r.status||'').toLowerCase()}</td>`;
        tbody.appendChild(tr);
      });
      setMsg('');
    }

    async function load(){
      setMsg('Loading...');
      try{
        const base = window.location.pathname.split('/frontend/')[0];
        const api = base + '/backend/api/appointments_new.php';
        const form = new URLSearchParams(); form.set('action','list');
        const r = await fetch(api, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: form.toString()});
        const dj = await r.json();
        const src = dj.success ? (dj.appointments||[]) : [];
        // Archived means final-state
        allRows = src.filter(a => ['declined','completed','cancelled'].includes(String(a.status||'').toLowerCase()));
        // Sort by date desc then time desc
        allRows.sort((a,b)=>{
          const da = String(a.date||''); const db = String(b.date||''); const t = da===db ? (String(b.time||'').localeCompare(String(a.time||''))) : db.localeCompare(da);
          return t;
        });
        apply();
      } catch {
        setMsg('Failed to load archived bookings.');
      }
    }

    search.addEventListener('input', apply);
    statusSel.addEventListener('change', apply);
    load();
  })();
  </script>
</body>
</html>
